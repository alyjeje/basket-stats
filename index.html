<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶Ü Statistiques Basketball CSMF</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #e91e63;
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Layout principal avec sidebar */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #003087;
            border-right: 1px solid rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            text-align: center;
        }

        .sidebar-header h1 {
            color: #ffffff;
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: rgba(255,255,255,0.9);
            font-size: 0.85em;
        }

        .sidebar-nav {
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.95);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            line-height: 1.5;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .nav-btn.active {
            background: rgba(228, 0, 43, 0.2);
            color: #E4002B;
            border-left: 3px solid #E4002B;
            font-weight: 600;
        }

        .nav-btn-icon {
            font-size: 1.2em;
        }

        /* Section upload dans sidebar */
        .sidebar-upload {
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 15px;
            background: #E4002B;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(228, 0, 43, 0.4);
            background: #c30025;
        }

        /* Modal d'upload */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .upload-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .upload-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
        }

        .upload-modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 1.2em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #64748b;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #1e293b;
        }

        .upload-modal-body {
            padding: 25px;
        }

        .upload-help {
            color: #475569;
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .upload-file-row {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .upload-file-row label {
            display: block;
            margin-bottom: 10px;
        }

        .file-label {
            color: #1e293b;
            font-weight: 600;
        }

        .file-required {
            color: #dc2626;
            font-size: 0.85em;
            margin-left: 5px;
        }

        .file-optional {
            color: #64748b;
            font-size: 0.85em;
            margin-left: 5px;
        }

        .upload-file-row input[type="file"] {
            display: none;
        }

        .file-select-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .file-select-btn:hover {
            background: #5a67d8;
        }

        .file-name {
            margin-left: 12px;
            color: #64748b;
            font-size: 0.9em;
        }

        .file-name.selected {
            color: #059669;
            font-weight: 500;
        }

        .upload-progress {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .progress-text {
            color: #0369a1;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .progress-bar {
            background: #e0f2fe;
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: #0ea5e9;
            height: 100%;
            width: 0%;
            animation: progress-anim 2s ease-in-out infinite;
        }

        @keyframes progress-anim {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        .upload-result {
            margin-top: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .upload-result.success {
            background: #eff6ff;
            border: 1px solid #1e40af;
            color: #1e3a8a;
        }

        .upload-result.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .upload-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #475569;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
        }

        .btn-cancel:hover {
            background: #cbd5e1;
        }

        .btn-import {
            background: #E4002B;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
        }

        .btn-import:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(228, 0, 43, 0.4);
            background: #c30025;
        }

        .btn-import:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Liste des matchs dans sidebar */
        .sidebar-matches {
            flex: 1;
            overflow-y: auto;
            padding: 15px 0;
        }

        .sidebar-section-title {
            color: #ffffff;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 10px 20px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .match-list-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            position: relative;
        }

        .match-list-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .match-list-item.active {
            background: rgba(228, 0, 43, 0.2);
            border-left-color: #E4002B;
        }

        .match-list-item.active .match-teams {
            font-weight: 600;
        }

        .match-journee {
            background: #E4002B;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
            margin-right: 10px;
            min-width: 28px;
            text-align: center;
        }

        .match-info {
            flex: 1;
            min-width: 0;
        }

        .match-teams {
            color: rgba(255,255,255,0.95);
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .match-score-small {
            color: rgba(255,255,255,0.8);
            font-size: 0.8em;
            margin-top: 2px;
        }

        /* Indicateur de r√©sultat - accessible avec texte et ic√¥ne */
        .match-result-indicator {
            min-width: 36px;
            height: 24px;
            border-radius: 4px;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            gap: 2px;
        }

        .match-result-indicator.win {
            background: #166534;
            color: #ffffff;
        }
        .match-result-indicator.loss {
            background: #991b1b;
            color: #ffffff;
        }

        .match-delete-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(239, 68, 68, 0.15);
            border: none;
            color: #f87171;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            font-size: 0.8em;
        }

        .match-list-item:hover .match-delete-btn {
            opacity: 1;
        }

        .match-delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* Contenu principal */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            background: #e91e63;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: none; /* Cach√© car on utilise la sidebar */
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: #1a202c;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #E4002B;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.3;
        }

        /* Header du match actuel */
        .current-match-header {
            background: #ffffff;
            padding: 25px 30px;
            border-radius: 15px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .match-badge {
            background: #E4002B;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.2em;
            min-width: 60px;
            text-align: center;
        }

        .match-title-info h2 {
            color: #1a202c;
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            padding: 0;
            border: none;
            line-height: 1.3;
        }

        .match-title-info p {
            color: #4a5568;
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.4;
        }

        .match-selector {
            display: none; /* Cach√© car on utilise la sidebar */
        }

        .match-btn {
            background: #f0f0f0;
            border: 2px solid #ddd;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .match-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .match-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .score-display {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr;
            gap: 20px;
            align-items: center;
            text-align: center;
            margin: 30px 0;
        }

        .team-score {
            font-size: 3em;
            font-weight: bold;
            color: #003087;
        }

        .vs {
            font-size: 1.5em;
            color: #999;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }

        th {
            background: #003087;
            color: #ffffff;
            padding: 12px 10px;
            text-align: center;
            font-weight: 700;
            font-size: 0.875rem;
            white-space: nowrap;
            line-height: 1.4;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            text-align: center;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #2d3748;
        }

        td:first-child {
            text-align: left;
            font-weight: 700;
            color: #1a202c;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .stat-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
            background: #003087;
            color: white;
            font-size: 13px;
        }

        .quarters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .quarter-box {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .quarter-box h3 {
            color: #003087;
            margin-bottom: 10px;
        }

        .quarter-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 1.5em;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            line-height: 1.4;
        }

        .tab:hover {
            color: #003087;
        }

        .tab.active {
            color: #003087;
            border-bottom-color: #E4002B;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #003087;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .top-scorer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9ff;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .top-scorer:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .rank-1 { background: gold; color: #333; }
        .rank-2 { background: silver; color: #333; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #3b82f6; color: white; }

        .team-section {
            margin-bottom: 40px;
        }

        .team-header {
            background: #003087;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-size: 1.3em;
            font-weight: bold;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        select, input[type="checkbox"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .summary-stats {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-stats h3 {
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .summary-item .label {
            font-size: 0.875rem;
            color: #4a5568;
            margin-bottom: 5px;
            font-weight: 600;
            line-height: 1.4;
        }

        .summary-item .value {
            font-size: 2rem;
            font-weight: 800;
            color: #1a202c;
            line-height: 1.2;
        }

        .scroll-table {
            overflow-x: auto;
        }

        /* Nouveaux styles pour la navigation principale */
        .main-tabs {
            display: none; /* Navigation via sidebar maintenant */
        }

        .main-tab {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            border: 3px solid transparent;
        }

        .main-tab:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .main-tab.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .main-tab h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .main-tab.active h3 {
            color: white;
        }

        .main-tab p {
            color: #666;
            font-size: 0.9em;
        }

        .main-tab.active p {
            color: rgba(255,255,255,0.9);
        }

        /* Boutons d'action */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #E4002B;
            color: #ffffff;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .btn-primary:hover {
            background: #c30025;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
            min-width: auto;
        }

        .btn-small:hover {
            transform: translateY(-1px);
        }

        /* Upload form */
        .upload-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px dashed #667eea;
        }

        .upload-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="file"] {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        /* Section Coach */
        .coach-analysis {
            background: #1e40af;
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            box-shadow: 0 10px 25px rgba(30, 64, 175, 0.3);
        }

        .coach-analysis h3 {
            color: white;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }

        .coach-analysis h4 {
            color: rgba(255, 255, 255, 0.9);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }

        .coach-analysis ul {
            list-style: none;
            padding: 0;
        }

        .coach-analysis li {
            padding: 8px 0 8px 25px;
            position: relative;
            line-height: 1.6;
        }

        .coach-analysis li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2em;
        }

        .coach-highlight {
            background: rgba(255, 255, 255, 0.15);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .coach-stat {
            color: #ffd700;
            font-weight: bold;
        }

        .coach-warning {
            color: #ff6b6b;
            font-weight: bold;
        }

        .coach-success {
            color: #51cf66;
            font-weight: bold;
        }

        /* ========== COACHING IA ========== */
        .coaching-card { background: #1e3a8a; color: white; padding: 30px; border-radius: 15px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .coaching-card h2 { color: white; border-bottom: 3px solid rgba(255,255,255,0.3); padding-bottom: 15px; margin-bottom: 25px; }
        .coaching-card h3 { color: #fff; font-size: 1.3em; margin-top: 25px; margin-bottom: 15px; }
        .coaching-summary { background: rgba(255,255,255,0.15); padding: 15px 20px; border-radius: 10px; margin-bottom: 25px; font-size: 1.1em; text-align: center; }
        .coaching-list { list-style: none; padding: 0; margin: 15px 0; }
        .coaching-list li { background: rgba(255,255,255,0.1); padding: 15px 20px; margin: 10px 0; border-radius: 10px; border-left: 4px solid #fff; line-height: 1.6; }
        .coaching-list.coaching-warning li { border-left-color: #ffd700; background: rgba(255,215,0,0.15); }
        .coaching-list.coaching-advice li { border-left-color: #4ade80; background: rgba(74,222,128,0.15); }
        .coaching-loader { text-align: center; padding: 40px 20px; }
        .coaching-loader .spinner { width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.2); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .coaching-error { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
        .coaching-error code { background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; font-family: monospace; }
        .coaching-footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; align-items: center; }
        .btn-refresh { background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-refresh:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }

        /* ========== COMBINAISONS DE 5 ========== */
        .lineup-section { margin-top: 30px; }
        .lineup-card { background: #334155; border-radius: 15px; padding: 20px; margin: 15px 0; color: white; }
        .lineup-card.positive { border-left: 5px solid #4ade80; }
        .lineup-card.negative { border-left: 5px solid #f87171; }
        .lineup-card.neutral { border-left: 5px solid #fbbf24; }
        .lineup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .lineup-ecart { font-size: 2em; font-weight: bold; }
        .lineup-ecart.positive { color: #4ade80; }
        .lineup-ecart.negative { color: #f87171; }
        .lineup-ecart.neutral { color: #fbbf24; }
        .lineup-meta { display: flex; gap: 20px; font-size: 0.9em; color: #e2e8f0; }
        .lineup-players { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .lineup-player { background: rgba(255,255,255,0.15); padding: 8px 15px; border-radius: 20px; font-size: 0.9em; color: #f1f5f9; }
        .lineup-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); }
        .lineup-stat { text-align: center; }
        .lineup-stat-value { font-size: 1.3em; font-weight: bold; color: #a5b4fc; }
        .lineup-stat-label { font-size: 0.8em; color: #cbd5e1; }

        /* Stats avanc√©es */
        .advanced-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .advanced-stat-card { background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid transparent; transition: all 0.3s; }
        .advanced-stat-card:hover { border-color: #1e40af; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(30, 64, 175, 0.2); }
        .advanced-stat-value { font-size: 2em; font-weight: bold; color: #1e3a8a; }
        .advanced-stat-label { font-size: 0.9em; color: #334155; margin-top: 5px; }
        .advanced-stat-detail { font-size: 0.8em; color: #475569; margin-top: 3px; }

        /* Toggle sections */
        .section-toggle { background: #1e3a8a; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 10px 5px; transition: all 0.3s; }
        .section-toggle:hover { background: #1e3a8a; transform: translateY(-2px); }
        .section-toggle.active { background: #1d4ed8; }
        .collapsible-section { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .collapsible-section.expanded { max-height: 5000px; }

        /* Filtres combinaisons */
        .lineup-filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .lineup-filter-btn { background: #e2e8f0; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s; color: #334155; }
        .lineup-filter-btn:hover { background: #cbd5e1; }
        .lineup-filter-btn.active { background: #fbbf24; color: #1e3a8a; }

        /* En-t√™tes de tableau triables */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
            transition: background 0.2s;
        }
        th.sortable:hover {
            background: rgba(30, 64, 175, 0.3);
        }
        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.4;
            font-size: 0.8em;
        }
        th.sortable.sort-asc::after {
            content: '‚ñ≤';
            opacity: 1;
            color: #1e40af;
        }
        th.sortable.sort-desc::after {
            content: '‚ñº';
            opacity: 1;
            color: #1e40af;
        }
        th.sortable.sort-asc, th.sortable.sort-desc {
            background: rgba(30, 64, 175, 0.2);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* RESPONSIVE MOBILE                                               */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* Bouton hamburger (cach√© sur desktop) */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #1e293b;
            z-index: 150;
            padding: 0 15px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .hamburger-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            padding: 10px;
            line-height: 1;
        }

        .mobile-header h1 {
            color: white;
            font-size: 1.2em;
            margin: 0;
        }

        .mobile-header-spacer {
            width: 44px; /* Pour √©quilibrer le hamburger */
        }

        /* Overlay pour fermer la sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Bouton fermer dans sidebar mobile */
        .sidebar-close {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            line-height: 1;
        }

        /* ‚ïê‚ïê‚ïê MEDIA QUERIES ‚ïê‚ïê‚ïê */

        @media (max-width: 900px) {
            /* Afficher le header mobile */
            .mobile-header {
                display: flex;
            }

            /* Sidebar coulissante */
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 200;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-close {
                display: block;
            }

            /* Contenu principal pleine largeur */
            .main-content {
                margin-left: 0;
                padding-top: 80px; /* Espace pour le header mobile */
                padding-left: 15px;
                padding-right: 15px;
            }

            /* Ajustements g√©n√©raux */
            .container {
                padding: 0;
            }

            .card {
                padding: 15px;
                border-radius: 10px;
            }

            /* Header du match plus compact */
            .current-match-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
                padding: 15px;
            }

            .match-badge {
                padding: 8px 15px;
            }

            .match-title-info h2 {
                font-size: 1.2em;
            }

            /* Score display responsive */
            .score-display {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .team-score {
                font-size: 2em;
            }

            /* Tabs scrollables */
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 10px;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                white-space: nowrap;
                flex-shrink: 0;
                padding: 10px 15px;
                font-size: 0.9em;
            }

            /* Tableaux responsives */
            .stats-table {
                font-size: 0.8em;
            }

            .stats-table th,
            .stats-table td {
                padding: 6px 4px;
            }

            /* Modal responsive */
            .upload-modal-content {
                width: 95%;
                max-height: 90vh;
                overflow-y: auto;
            }

            .upload-file-row {
                padding: 12px;
            }

            .file-name {
                display: block;
                margin-left: 0;
                margin-top: 8px;
            }

            /* Stats cards */
            .stat-card {
                padding: 12px;
            }

            .stat-card .value {
                font-size: 1.5em;
            }

            /* Lineup cards */
            .lineup-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .lineup-players {
                justify-content: center;
            }

            /* Coach analysis */
            .coaching-card {
                padding: 20px 15px;
            }
        }

        @media (max-width: 500px) {
            /* Encore plus petit */
            .team-score {
                font-size: 1.5em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .advanced-stats-grid {
                grid-template-columns: 1fr;
            }

            .lineup-stats {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .player-bar-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .player-name {
                margin-bottom: 5px;
            }
        }

    </style>
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <!-- Header mobile (visible uniquement sur petit √©cran) -->
    <header class="mobile-header">
        <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
        <h1>ü¶Ü CSMF Stats</h1>
        <div class="mobile-header-spacer"></div>
    </header>

    <!-- Overlay pour fermer la sidebar sur mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
            <div class="sidebar-header">
                <h1>ü¶Ü CSMF Stats</h1>
                <p>Analyse des performances</p>
            </div>

            <!-- Section Upload -->
            <div class="sidebar-upload">
                <button class="upload-btn" onclick="closeSidebar(); openUploadModal()">
                    <span>‚ûï</span>
                    <span>Importer un match</span>
                </button>
            </div>

            <!-- Modal d'upload -->
            <div id="uploadModal" class="upload-modal" style="display: none;">
                <div class="upload-modal-content">
                    <div class="upload-modal-header">
                        <h3>üì• Importer un nouveau match</h3>
                        <button class="modal-close" onclick="closeUploadModal()">‚úï</button>
                    </div>
                    <div class="upload-modal-body">
                        <p class="upload-help">S√©lectionnez les 3 fichiers PDF de la f√©d√©ration :</p>

                        <div class="upload-file-row">
                            <label>
                                <span class="file-label">1. FIBA Box Score</span>
                                <span class="file-required">(obligatoire)</span>
                            </label>
                            <input type="file" id="modalFibaFile" accept=".pdf" onchange="updateFileLabel(this, 'modalFibaLabel')">
                            <button class="file-select-btn" onclick="document.getElementById('modalFibaFile').click()">
                                Choisir...
                            </button>
                            <span id="modalFibaLabel" class="file-name">Aucun fichier</span>
                        </div>

                        <div class="upload-file-row">
                            <label>
                                <span class="file-label">2. Boxscore D√©taill√©e</span>
                                <span class="file-optional">(optionnel)</span>
                            </label>
                            <input type="file" id="modalBoxscoreFile" accept=".pdf" onchange="updateFileLabel(this, 'modalBoxscoreLabel')">
                            <button class="file-select-btn" onclick="document.getElementById('modalBoxscoreFile').click()">
                                Choisir...
                            </button>
                            <span id="modalBoxscoreLabel" class="file-name">Aucun fichier</span>
                        </div>

                        <div class="upload-file-row">
                            <label>
                                <span class="file-label">3. Analyse des 5 en jeu</span>
                                <span class="file-optional">(optionnel)</span>
                            </label>
                            <input type="file" id="modalAnalyse5File" accept=".pdf" onchange="updateFileLabel(this, 'modalAnalyse5Label')">
                            <button class="file-select-btn" onclick="document.getElementById('modalAnalyse5File').click()">
                                Choisir...
                            </button>
                            <span id="modalAnalyse5Label" class="file-name">Aucun fichier</span>
                        </div>

                        <div id="uploadProgress" class="upload-progress" style="display: none;">
                            <div class="progress-text">Import en cours...</div>
                            <div class="progress-bar"><div class="progress-fill"></div></div>
                        </div>

                        <div id="uploadResult" class="upload-result"></div>
                    </div>
                    <div class="upload-modal-footer">
                        <button class="btn-cancel" onclick="closeUploadModal()">Annuler</button>
                        <button class="btn-import" onclick="importMatchFiles()">Importer le match</button>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav" id="sidebar-nav">
                <!-- Navigation g√©n√©r√©e par JS -->
            </nav>
            <div class="sidebar-matches" id="sidebar-matches">
                <!-- Liste des matchs g√©n√©r√©e par JS -->
            </div>
        </aside>

        <!-- Contenu principal -->
        <main class="main-content">
            <div class="container">
                <div id="app">
                    <div class="loading">‚è≥ Chargement des donn√©es...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration API
        const API_URL = '/api';
        const CLUB_NAME = 'CSMF';

        // Fonction pour formater les dates en fran√ßais
        function formatDateFrench(dateStr, format = 'short') {
            if (!dateStr) return '';

            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr; // Si la date n'est pas valide, retourner la cha√Æne originale

                const options = {
                    timeZone: 'Europe/Paris'
                };

                if (format === 'long') {
                    options.weekday = 'long';
                    options.day = 'numeric';
                    options.month = 'long';
                    options.year = 'numeric';
                    return date.toLocaleDateString('fr-FR', options);
                } else if (format === 'short') {
                    options.day = '2-digit';
                    options.month = '2-digit';
                    options.year = 'numeric';
                    return date.toLocaleDateString('fr-FR', options);
                } else if (format === 'compact') {
                    options.day = 'numeric';
                    options.month = 'short';
                    options.year = 'numeric';
                    return date.toLocaleDateString('fr-FR', options);
                }

                return date.toLocaleDateString('fr-FR');
            } catch (e) {
                return dateStr;
            }
        }

        // Fonction pour formater date + heure
        function formatDateTimeFrench(dateStr, timeStr) {
            const formattedDate = formatDateFrench(dateStr, 'short');
            if (timeStr) {
                return `${formattedDate} - ${timeStr}`;
            }
            return formattedDate;
        }

        // √âtat de l'application
        let allMatches = [];
        let currentMatch = null;
        let currentView = 'accueil'; // 'accueil', 'csmf', 'matches', ou 'autres'
        let currentTab = 'overview';
        let selectedMatchesForCsmf = [];
        let csmfDataCache = null;

        // √âtat du tri pour le tableau CSMF
        let csmfSortColumn = 'evaluation'; // Colonne par d√©faut
        let csmfSortDirection = 'desc'; // 'asc' ou 'desc'

        // Autres √©quipes
        let allNonCsmfMatches = [];
        let selectedTeam = null;
        let teamMatches = [];
        let selectedOpponents = [];
        let teamStatsCache = null;

        // Fonction pour obtenir un nom d'√©quipe court mais lisible
        function getShortTeamName(fullName) {
            if (!fullName) return '';

            // Mapping des noms connus vers des noms courts
            const knownNames = {
                'CSMF PARIS': 'CSMF',
                'CSMF BASKET': 'CSMF',
                'ARRAS PAYS D\'ARTOIS': 'ARRAS',
                'RED STAR CLUB CHAMPIGNY': 'CHAMPIGNY',
                'AUBERVILLIERS AVENIR BASKETBALL': 'AUBERVILLIERS',
                'DOUAI BASKET FEMININ': 'DOUAI',
                'VGA ST MAUR': 'VGA ST MAUR',
                'SAINT AMAND HAINAUD BADKET': 'ST AMAND',
                'SAINT AMAND': 'ST AMAND'
            };

            // Chercher dans les noms connus
            for (const [full, short] of Object.entries(knownNames)) {
                if (fullName.toUpperCase().includes(full)) {
                    return short;
                }
            }

            // Sinon, prendre les 2 premiers mots significatifs
            const words = fullName.split(' ').filter(w => w.length > 2);
            if (words.length >= 2) {
                return words.slice(0, 2).join(' ');
            }
            return words[0] || fullName.split(' ')[0];
        }

        // Initialisation
        async function init() {
            try {
                await loadMatches();
            } catch (error) {
                showError('Erreur de chargement des donn√©es: ' + error.message);
            }
        }

        // Charger la liste des matchs
        async function loadMatches() {
            const response = await fetch(`${API_URL}/matches`);
            const result = await response.json();

            if (result.success) {
                allMatches = result.data;
                // Trier par journ√©e (J10, J9, J8... - la plus r√©cente en haut)
                allMatches.sort((a, b) => {
                    const jA = a.journee ? parseInt(a.journee.replace('J', '')) : 0;
                    const jB = b.journee ? parseInt(b.journee.replace('J', '')) : 0;
                    return jB - jA; // Descendant: plus grande journ√©e en premier
                });
                selectedMatchesForCsmf = allMatches.map(m => m.id); // Tous s√©lectionn√©s par d√©faut
                renderSidebar();
                // Toujours afficher la page d'accueil par d√©faut
                render();
            } else {
                throw new Error(result.error);
            }
        }

        // Rendre la sidebar
        function renderSidebar() {
            const navEl = document.getElementById('sidebar-nav');
            const matchesEl = document.getElementById('sidebar-matches');

            // Safeguard si les √©l√©ments n'existent pas encore
            if (!navEl || !matchesEl) return;

            // Navigation principale
            const navHtml = `
                <button class="nav-btn ${currentView === 'accueil' ? 'active' : ''}" onclick="setView('accueil'); closeSidebar();">
                    <span class="nav-btn-icon">üè†</span>
                    <span>Accueil</span>
                </button>
                <button class="nav-btn ${currentView === 'csmf' ? 'active' : ''}" onclick="setView('csmf'); closeSidebar();">
                    <span class="nav-btn-icon">üèÜ</span>
                    <span>Stats CSMF</span>
                </button>
                <button class="nav-btn ${currentView === 'matches' ? 'active' : ''}" onclick="setView('matches'); closeSidebar();">
                    <span class="nav-btn-icon">üìä</span>
                    <span>Analyse Match</span>
                </button>
                <button class="nav-btn ${currentView === 'autres' ? 'active' : ''}" onclick="setView('autres'); closeSidebar();">
                    <span class="nav-btn-icon">üë•</span>
                    <span>Autres √âquipes</span>
                </button>
            `;
            navEl.innerHTML = navHtml;

            // Liste des matchs
            let matchesHtml = `
                <div class="sidebar-section-title">
                    <span>Matchs (${allMatches.length})</span>
                </div>
            `;

            if (allMatches.length === 0) {
                matchesHtml += `
                    <div style="padding: 20px; text-align: center; color: #cbd5e1;">
                        <p>Aucun match</p>
                        <p style="font-size: 0.8em; margin-top: 10px;">Cliquez sur "Importer" ci-dessus</p>
                    </div>
                `;
            } else {
                allMatches.forEach(m => {
                    const isCsmfHome = m.equipe_domicile && m.equipe_domicile.includes('CSMF');
                    const csmfWon = (isCsmfHome && m.score_domicile > m.score_exterieur) ||
                                   (!isCsmfHome && m.score_exterieur > m.score_domicile);
                    const resultClass = csmfWon ? 'win' : 'loss';
                    const resultText = csmfWon ? '‚úì V' : '‚úó D';
                    const isActive = currentMatch && currentMatch.id === m.id;

                    matchesHtml += `
                        <div class="match-list-item ${isActive ? 'active' : ''}" onclick="loadMatch(${m.id}); closeSidebar();">
                            ${m.journee ? `<span class="match-journee">${m.journee}</span>` : ''}
                            <div class="match-info">
                                <div class="match-teams">${getShortTeamName(m.equipe_domicile)} vs ${getShortTeamName(m.equipe_exterieur)}</div>
                                <div class="match-score-small">${m.score_domicile} - ${m.score_exterieur}</div>
                                <div style="font-size: 0.75em; color: #cbd5e1; margin-top: 2px;">üìÖ ${formatDateFrench(m.date, 'compact')}</div>
                            </div>
                            <span class="match-result-indicator ${resultClass}">${resultText}</span>
                            <button class="match-delete-btn" onclick="deleteMatch(${m.id}, event)" title="Supprimer">üóë</button>
                        </div>
                    `;
                });
            }

            matchesEl.innerHTML = matchesHtml;
        }

        // Charger un match sp√©cifique
        async function loadMatch(matchId) {
            const response = await fetch(`${API_URL}/matches/${matchId}`);
            const result = await response.json();

            if (result.success) {
                currentMatch = result.data;

                // Charger aussi les combinaisons de 5 si disponibles
                try {
                    const lineupsResponse = await fetch(`${API_URL}/matches/${matchId}/lineups`);
                    const lineupsResult = await lineupsResponse.json();
                    if (lineupsResult.success) {
                        currentMatch.stats_cinq_majeur = lineupsResult.data;
                    }
                } catch (e) {
                    // Les combinaisons ne sont pas disponibles, ce n'est pas grave
                    currentMatch.stats_cinq_majeur = [];
                }

                currentView = 'matches';
                render();
            } else {
                throw new Error(result.error);
            }
        }

        // Supprimer un match
        async function deleteMatch(matchId, event) {
            event.stopPropagation(); // Emp√™cher le clic de s√©lectionner le match

            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce match ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/matches/${matchId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Match supprim√© avec succ√®s !');
                    // Recharger la liste des matchs
                    await loadMatches();
                    // Si c'√©tait le match actuel, retourner √† la vue principale
                    if (currentMatch && currentMatch.id === matchId) {
                        currentMatch = null;
                        currentView = 'matches';
                    }
                    render();
                } else {
                    alert('‚ùå Erreur: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors de la suppression: ' + error.message);
            }
        }

        // Uploader un nouveau match
        async function uploadMatch() {
            const fileInput = document.getElementById('pdfFile');
            const messageDiv = document.getElementById('uploadMessage');

            if (!fileInput.files || fileInput.files.length === 0) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Veuillez s√©lectionner un fichier PDF';
                return;
            }

            const file = fileInput.files[0];

            if (!file.name.toLowerCase().endsWith('.pdf')) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Seuls les fichiers PDF sont accept√©s';
                return;
            }

            // Cr√©er un FormData pour envoyer le fichier
            const formData = new FormData();
            formData.append('file', file);

            // Afficher un message de chargement
            messageDiv.className = 'message show';
            messageDiv.innerHTML = '<span class="loading"></span> Import en cours...';

            try {
                const response = await fetch(`${API_URL}/matches/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.className = 'message success show';
                    messageDiv.textContent = '‚úÖ Match import√© avec succ√®s !';

                    // R√©initialiser le champ de fichier
                    fileInput.value = '';

                    // Recharger la liste des matchs
                    await loadMatches();
                    render();

                    // Cacher le message apr√®s 3 secondes
                    setTimeout(() => {
                        messageDiv.className = 'message';
                    }, 3000);
                } else {
                    messageDiv.className = 'message error show';
                    messageDiv.textContent = '‚ùå Erreur: ' + result.error;
                }
            } catch (error) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Erreur lors de l\'upload: ' + error.message;
            }
        }

        // === SIDEBAR MOBILE ===

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // Fermer la sidebar quand on clique sur un match (mobile)
        function loadMatchAndCloseSidebar(matchId) {
            closeSidebar();
            loadMatch(matchId);
        }

        // === MODAL D'UPLOAD ===

        function openUploadModal() {
            document.getElementById('uploadModal').style.display = 'flex';
            // R√©initialiser le formulaire
            document.getElementById('modalFibaFile').value = '';
            document.getElementById('modalBoxscoreFile').value = '';
            document.getElementById('modalAnalyse5File').value = '';
            document.getElementById('modalFibaLabel').textContent = 'Aucun fichier';
            document.getElementById('modalFibaLabel').className = 'file-name';
            document.getElementById('modalBoxscoreLabel').textContent = 'Aucun fichier';
            document.getElementById('modalBoxscoreLabel').className = 'file-name';
            document.getElementById('modalAnalyse5Label').textContent = 'Aucun fichier';
            document.getElementById('modalAnalyse5Label').className = 'file-name';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadResult').innerHTML = '';
            document.getElementById('uploadResult').className = 'upload-result';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
        }

        function updateFileLabel(input, labelId) {
            const label = document.getElementById(labelId);
            if (input.files && input.files.length > 0) {
                label.textContent = input.files[0].name;
                label.className = 'file-name selected';
            } else {
                label.textContent = 'Aucun fichier';
                label.className = 'file-name';
            }
        }

        async function importMatchFiles() {
            const fibaInput = document.getElementById('modalFibaFile');
            const boxscoreInput = document.getElementById('modalBoxscoreFile');
            const analyse5Input = document.getElementById('modalAnalyse5File');
            const progressDiv = document.getElementById('uploadProgress');
            const resultDiv = document.getElementById('uploadResult');

            // V√©rifier le fichier obligatoire
            if (!fibaInput.files || fibaInput.files.length === 0) {
                resultDiv.className = 'upload-result error';
                resultDiv.innerHTML = '‚ùå Le fichier FIBA Box Score est obligatoire';
                return;
            }

            const fibaFile = fibaInput.files[0];
            if (!fibaFile.name.toLowerCase().endsWith('.pdf')) {
                resultDiv.className = 'upload-result error';
                resultDiv.innerHTML = '‚ùå Seuls les fichiers PDF sont accept√©s';
                return;
            }

            // Cr√©er un FormData avec tous les fichiers
            const formData = new FormData();
            formData.append('file_fiba', fibaFile);

            // Ajouter les fichiers optionnels
            if (boxscoreInput.files && boxscoreInput.files.length > 0) {
                formData.append('file_boxscore', boxscoreInput.files[0]);
            }
            if (analyse5Input.files && analyse5Input.files.length > 0) {
                formData.append('file_analyse5', analyse5Input.files[0]);
            }

            // Compter les fichiers
            let fileCount = 1;
            if (boxscoreInput.files?.length > 0) fileCount++;
            if (analyse5Input.files?.length > 0) fileCount++;

            // Afficher la progression
            progressDiv.style.display = 'block';
            progressDiv.querySelector('.progress-text').textContent = `Import de ${fileCount} fichier(s) en cours...`;
            resultDiv.innerHTML = '';
            resultDiv.className = 'upload-result';

            try {
                const response = await fetch(`${API_URL}/matches/upload-multiple`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                progressDiv.style.display = 'none';

                if (result.success) {
                    let successMsg = '‚úÖ Match import√© avec succ√®s !';
                    if (result.lineups_count > 0) {
                        successMsg += `<br>üìä ${result.lineups_count} combinaisons de 5 ajout√©es`;
                    }

                    resultDiv.className = 'upload-result success';
                    resultDiv.innerHTML = successMsg;

                    // Recharger la liste des matchs
                    await loadMatches();

                    // Fermer la modal apr√®s 2 secondes
                    setTimeout(() => {
                        closeUploadModal();
                        render();
                    }, 2000);
                } else {
                    resultDiv.className = 'upload-result error';
                    resultDiv.innerHTML = '‚ùå Erreur: ' + result.error;
                }
            } catch (error) {
                progressDiv.style.display = 'none';
                resultDiv.className = 'upload-result error';
                resultDiv.innerHTML = '‚ùå Erreur lors de l\'upload: ' + error.message;
            }
        }

        // Uploader plusieurs fichiers PDF (FIBA + Boxscore + Analyse 5)
        async function uploadMatchMultiple() {
            const fibaInput = document.getElementById('pdfFileFiba');
            const boxscoreInput = document.getElementById('pdfFileBoxscore');
            const analyse5Input = document.getElementById('pdfFileAnalyse5');
            const messageDiv = document.getElementById('uploadMessage');

            // V√©rifier le fichier obligatoire
            if (!fibaInput.files || fibaInput.files.length === 0) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Le fichier FIBA Box Score est obligatoire';
                return;
            }

            const fibaFile = fibaInput.files[0];
            if (!fibaFile.name.toLowerCase().endsWith('.pdf')) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Seuls les fichiers PDF sont accept√©s';
                return;
            }

            // Cr√©er un FormData avec tous les fichiers
            const formData = new FormData();
            formData.append('file_fiba', fibaFile);

            // Ajouter les fichiers optionnels s'ils sont pr√©sents
            if (boxscoreInput.files && boxscoreInput.files.length > 0) {
                formData.append('file_boxscore', boxscoreInput.files[0]);
            }
            if (analyse5Input.files && analyse5Input.files.length > 0) {
                formData.append('file_analyse5', analyse5Input.files[0]);
            }

            // Compter les fichiers
            let fileCount = 1;
            if (boxscoreInput.files?.length > 0) fileCount++;
            if (analyse5Input.files?.length > 0) fileCount++;

            // Afficher un message de chargement
            messageDiv.className = 'message show';
            messageDiv.innerHTML = `<span class="loading"></span> Import de ${fileCount} fichier(s) en cours...`;

            try {
                const response = await fetch(`${API_URL}/matches/upload-multiple`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    let successMsg = '‚úÖ Match import√© avec succ√®s !';
                    if (result.lineups_count > 0) {
                        successMsg += ` (${result.lineups_count} combinaisons de 5 ajout√©es)`;
                    }

                    messageDiv.className = 'message success show';
                    messageDiv.textContent = successMsg;

                    // R√©initialiser les champs
                    fibaInput.value = '';
                    boxscoreInput.value = '';
                    analyse5Input.value = '';

                    // Recharger la liste des matchs
                    await loadMatches();
                    render();

                    // Cacher le message apr√®s 5 secondes
                    setTimeout(() => {
                        messageDiv.className = 'message';
                    }, 5000);
                } else {
                    messageDiv.className = 'message error show';
                    messageDiv.textContent = '‚ùå Erreur: ' + result.error;
                }
            } catch (error) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Erreur lors de l\'upload: ' + error.message;
            }
        }

        // Uploader le fichier Analyse des 5 pour un match existant
        async function uploadAnalyse5(matchId) {
            const fileInput = document.getElementById('analyse5File');
            const messageDiv = document.getElementById('analyse5Message');

            if (!fileInput.files || fileInput.files.length === 0) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Veuillez s√©lectionner un fichier PDF';
                return;
            }

            const file = fileInput.files[0];
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Seuls les fichiers PDF sont accept√©s';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            messageDiv.className = 'message show';
            messageDiv.innerHTML = '‚è≥ Import en cours...';

            try {
                const response = await fetch(`${API_URL}/matches/${matchId}/lineups/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.className = 'message success show';
                    messageDiv.textContent = `‚úÖ ${result.count} combinaisons import√©es !`;

                    // Recharger le match
                    await loadMatch(matchId);
                } else {
                    messageDiv.className = 'message error show';
                    messageDiv.textContent = '‚ùå Erreur: ' + result.error;
                }
            } catch (error) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Erreur: ' + error.message;
            }
        }

        // Supprimer les donn√©es de combinaisons de 5
        async function deleteLineupsData(matchId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer les donn√©es de combinaisons de 5 ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/matches/${matchId}/lineups`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Donn√©es supprim√©es !');
                    await loadMatch(matchId);
                } else {
                    alert('‚ùå Erreur: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // Uploader le fichier Boxscore D√©taill√©e pour un match existant
        async function uploadBoxscore(matchId) {
            const fileInput = document.getElementById('boxscoreFile');
            const messageDiv = document.getElementById('boxscoreMessage');

            if (!fileInput.files || fileInput.files.length === 0) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Veuillez s√©lectionner un fichier PDF';
                return;
            }

            const file = fileInput.files[0];
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Seuls les fichiers PDF sont accept√©s';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            messageDiv.className = 'message show';
            messageDiv.innerHTML = '‚è≥ Import en cours...';

            try {
                const response = await fetch(`${API_URL}/matches/${matchId}/advanced-stats/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.className = 'message success show';
                    messageDiv.textContent = '‚úÖ Stats avanc√©es import√©es !';

                    // Recharger le match
                    await loadMatch(matchId);
                } else {
                    messageDiv.className = 'message error show';
                    messageDiv.textContent = '‚ùå Erreur: ' + result.error;
                }
            } catch (error) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Erreur: ' + error.message;
            }
        }

        // Supprimer les stats avanc√©es
        async function deleteAdvancedStats(matchId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer les stats avanc√©es ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/matches/${matchId}/advanced-stats`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Donn√©es supprim√©es !');
                    await loadMatch(matchId);
                } else {
                    alert('‚ùå Erreur: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // Afficher une erreur
        function showError(message) {
            document.getElementById('app').innerHTML = `
                <div class="error">
                    <strong>‚ùå Erreur:</strong> ${message}
                </div>
            `;
        }

        // Vue d'accueil
        function renderAccueilView() {
            return `
                <div class="card">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">ü¶Ü</div>
                        <h1 style="color: #1a202c; font-size: 2.5em; margin-bottom: 15px; border: none;">Bienvenue sur CSMF Stats</h1>
                        <p style="color: #64748b; font-size: 1.2em; margin-bottom: 40px;">Plateforme d'analyse des performances basketball du CSMF Paris</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px;">
                    <div class="card" style="cursor: pointer; transition: transform 0.3s;" onclick="setView('csmf')" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üìä</div>
                            <h2 style="color: #1a202c; margin-bottom: 15px; border: none;">Stats CSMF</h2>
                            <p style="color: #64748b; margin-bottom: 20px;">Analyse globale des performances de l'√©quipe CSMF sur plusieurs matchs</p>
                            <ul style="text-align: left; color: #64748b; font-size: 0.9em; line-height: 1.6;">
                                <li>üìä Statistiques moyennes par joueuse</li>
                                <li>üéØ Pourcentages de r√©ussite aux tirs</li>
                                <li>‚öΩ Meilleures combinaisons de 11</li>
                                <li>ü§ñ Analyse IA globale</li>
                                <li>üìà √âvolution des performances</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card" style="cursor: pointer; transition: transform 0.3s;" onclick="setView('matches')" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üèÜ</div>
                            <h2 style="color: #1a202c; margin-bottom: 15px; border: none;">Analyse Match</h2>
                            <p style="color: #64748b; margin-bottom: 20px;">Analyse d√©taill√©e d'un match sp√©cifique avec toutes les statistiques</p>
                            <ul style="text-align: left; color: #64748b; font-size: 0.9em; line-height: 1.6;">
                                <li>‚öΩ Score et r√©sultat du match</li>
                                <li>üë• Stats individuelles par √©quipe</li>
                                <li>‚öΩ Combinaisons de 11 joueurs</li>
                                <li>ü§ñ Conseils IA tactiques</li>
                                <li>üìà Graphiques de performance</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card" style="cursor: pointer; transition: transform 0.3s;" onclick="setView('autres')" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üë•</div>
                            <h2 style="color: #1a202c; margin-bottom: 15px; border: none;">Autres √âquipes</h2>
                            <p style="color: #64748b; margin-bottom: 20px;">Analyse des √©quipes adverses pour pr√©parer les prochains matchs</p>
                            <ul style="text-align: left; color: #64748b; font-size: 0.9em; line-height: 1.6;">
                                <li>üìã Import de matchs sans CSMF</li>
                                <li>üéØ S√©lection d'√©quipe √† analyser</li>
                                <li>üìä Stats des joueuses adverses</li>
                                <li>üîç Filtrage par adversaire</li>
                                <li>üìà Tendances et faiblesses</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üöÄ Comment commencer ?</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
                            <h3 style="color: #667eea; margin-bottom: 10px;">1. Importer des matchs</h3>
                            <p style="color: #64748b; font-size: 0.9em;">Cliquez sur le bouton "Importer un match" dans la sidebar pour ajouter vos fichiers PDF de la f√©d√©ration.</p>
                        </div>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
                            <h3 style="color: #10b981; margin-bottom: 10px;">2. Analyser CSMF</h3>
                            <p style="color: #64748b; font-size: 0.9em;">Acc√©dez aux "Stats CSMF" pour voir les performances globales de votre √©quipe.</p>
                        </div>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                            <h3 style="color: #f59e0b; margin-bottom: 10px;">3. D√©tailler un match</h3>
                            <p style="color: #64748b; font-size: 0.9em;">S√©lectionnez un match dans la liste pour une analyse d√©taill√©e avec l'IA.</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üìÅ Types de fichiers support√©s</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div style="background: #dcfce7; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üìÑ</div>
                            <h4 style="color: #166534; margin-bottom: 8px;">FIBA Box Score</h4>
                            <p style="color: #15803d; font-size: 0.85em;">Obligatoire - Stats de base</p>
                        </div>
                        <div style="background: #dbeafe; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üìä</div>
                            <h4 style="color: #1d4ed8; margin-bottom: 8px;">Boxscore D√©taill√©e</h4>
                            <p style="color: #2563eb; font-size: 0.85em;">Optionnel - Stats avanc√©es</p>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üèÄ</div>
                            <h4 style="color: #92400e; margin-bottom: 8px;">Analyse des 5</h4>
                            <p style="color: #a16207; font-size: 0.85em;">Optionnel - Combinaisons</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Changer de vue principale
        async function switchView(view) {
            currentView = view;
            if (view === 'csmf') {
                // Charger les donn√©es CSMF
                await loadCsmfDataAsync();
            } else if (view === 'autres') {
                // Charger les matchs non-CSMF
                await loadNonCsmfMatches();
            }
            render();
        }

        // Alias pour la sidebar
        function setView(view) {
            switchView(view);
        }

        // Charger les donn√©es CSMF de mani√®re asynchrone
        async function loadCsmfDataAsync() {
            const loadingEl = document.getElementById('csmf-content');
            if (loadingEl) {
                loadingEl.innerHTML = '<div class="loading">‚è≥ Chargement des statistiques CSMF...</div>';
            }

            csmfDataCache = await loadCsmfData();
            render();
        }

        // Rendu principal
        function render() {
            const app = document.getElementById('app');

            // Mettre √† jour la sidebar
            renderSidebar();

            let contentView = '';
            if (currentView === 'accueil') {
                contentView = renderAccueilView();
            } else if (currentView === 'matches') {
                contentView = renderMatchesView();
            } else if (currentView === 'csmf') {
                contentView = renderCsmfViewContent();
            } else if (currentView === 'autres') {
                contentView = renderAutresView();
            }

            // Plus besoin des onglets principaux, on a la sidebar
            app.innerHTML = contentView;

            attachEventListeners();
        }

        // Onglets principaux de navigation (gard√© pour compatibilit√© mais non utilis√©)
        function renderMainTabs() {
            return ''; // La navigation est maintenant dans la sidebar
        }

        // Vue des matchs (ancienne interface)
        function renderMatchesView() {
            if (!currentMatch) {
                return `
                    <div class="card" style="text-align: center; padding: 60px 30px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üèÄ</div>
                        <h2 style="border: none; margin-bottom: 15px;">Aucun match disponible</h2>
                        <p style="color: #64748b; margin-bottom: 25px;">Importez des matchs via l'API pour commencer l'analyse</p>
                        <code style="background: #f1f5f9; padding: 10px 20px; border-radius: 8px; color: #475569;">
                            POST /api/upload avec fichier PDF
                        </code>
                    </div>
                `;
            }

            return `
                ${renderMatchSelector()}
                ${renderTabs()}
            `;
        }

        // S√©lecteur de match
        function renderMatchSelector() {
            // Header avec info du match actuel
            const matchHeader = currentMatch ? `
                <div class="current-match-header">
                    <div class="match-badge">${currentMatch.journee || 'Match'}</div>
                    <div class="match-title-info">
                        <h2>${getShortTeamName(currentMatch.equipe_domicile)} vs ${getShortTeamName(currentMatch.equipe_exterieur)}</h2>
                        <p>Score: ${currentMatch.score_domicile} - ${currentMatch.score_exterieur}</p>
                        <div style="color: #e2e8f0; font-size: 0.9em; margin-top: 5px;">${formatDateFrench(currentMatch.date, 'long')}</div>
                    </div>
                </div>
            ` : '';

            return matchHeader;
        }

        // Onglets (pour la vue par match)
        function renderTabs() {
            return `
                <div class="card">
                    <div class="tabs">
                        <button class="tab ${currentTab === 'overview' ? 'active' : ''}"
                                onclick="switchTab('overview')">
                            üìä Vue d'ensemble
                        </button>
                        <button class="tab ${currentTab === 'players' ? 'active' : ''}"
                                onclick="switchTab('players')">
                            üë• Joueuses par √âquipe
                        </button>
                        <button class="tab ${currentTab === 'lineups' ? 'active' : ''}"
                                onclick="switchTab('lineups')">
                            üèÄ Combinaisons 5
                        </button>
                        <button class="tab ${currentTab === 'stats' ? 'active' : ''}"
                                onclick="switchTab('stats')">
                            üìà Statistiques Match
                        </button>
                    </div>
                    ${renderTabContentInner()}
                </div>
            `;
        }

        function renderTabContentInner() {
            if (currentTab === 'overview') {
                return renderOverview();
            } else if (currentTab === 'players') {
                return renderPlayersByTeam();
            } else if (currentTab === 'lineups') {
                return renderLineups();
            } else {
                return renderStats();
            }
        }

        // Analyse tactique pour un match CSMF
        // Analyse tactique pour la vue globale CSMF
        // Vue d'ensemble
        function renderOverview() {
            const players = currentMatch.stats_joueuses || [];
            const topScorers = [...players].sort((a, b) => (b.evaluation || 0) - (a.evaluation || 0)).slice(0, 5);

            return `
                <div class="tab-content active">
                    <h2>R√©sultat du Match</h2>
                    <div class="score-display">
                        <div>
                            <h3>${currentMatch.equipe_domicile}</h3>
                            <div class="team-score">${currentMatch.score_domicile}</div>
                        </div>
                        <div class="vs">
                            <div>VS</div>
                            <small>${currentMatch.date}<br>${currentMatch.heure}</small>
                        </div>
                        <div>
                            <h3>${currentMatch.equipe_exterieur}</h3>
                            <div class="team-score">${currentMatch.score_exterieur}</div>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">Score par Quart-Temps</h2>
                    <div class="quarters">
                        <div class="quarter-box">
                            <h3>Q1</h3>
                            <div class="quarter-score">${currentMatch.q1_domicile} - ${currentMatch.q1_exterieur}</div>
                        </div>
                        <div class="quarter-box">
                            <h3>Q2</h3>
                            <div class="quarter-score">${currentMatch.q2_domicile} - ${currentMatch.q2_exterieur}</div>
                        </div>
                        <div class="quarter-box">
                            <h3>Q3</h3>
                            <div class="quarter-score">${currentMatch.q3_domicile} - ${currentMatch.q3_exterieur}</div>
                        </div>
                        <div class="quarter-box">
                            <h3>Q4</h3>
                            <div class="quarter-score">${currentMatch.q4_domicile} - ${currentMatch.q4_exterieur}</div>
                        </div>
                    </div>
                    <div style="text-align: center; color: #94a3b8; font-size: 0.8em; margin-top: 10px;">
                        üïê ${formatDateTimeFrench(currentMatch.date, currentMatch.heure)}
                    </div>

                    <h2 style="margin-top: 30px;">üèÜ Top 5 Joueuses du Match (par Evaluation)</h2>
                    ${topScorers.map((p, i) => `
                        <div class="top-scorer">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="rank rank-${i < 3 ? i + 1 : 'other'}">${i + 1}</div>
                                <div>
                                    <strong>${p.nom}</strong><br>
                                    <small style="color: #666;">${p.equipe}</small>
                                </div>
                            </div>
                            <div>
                                <span class="stat-badge">EVAL: ${p.evaluation || 0}</span>
                                ${p.points || 0} pts ‚Ä¢ ${p.rebonds_total || 0} reb ‚Ä¢ ${p.passes_decisives || 0} pd
                            </div>
                        </div>
                    `).join('')}

                    ${renderOptionalFilesSection()}

                    ${renderCoachAnalysisForMatch()}
                </div>
            `;
        }

        // Section des fichiers optionnels (Boxscore D√©taill√©e et Analyse des 5)
        function renderOptionalFilesSection() {
            const hasLineups = currentMatch.stats_cinq_majeur && currentMatch.stats_cinq_majeur.length > 0;
            const hasAdvancedStats = currentMatch.stats_avancees && Object.keys(currentMatch.stats_avancees).length > 0;

            return `
                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 15px; border: 2px solid #e2e8f0;">
                    <h2 style="margin-bottom: 20px;">üìÅ Donn√©es Compl√©mentaires</h2>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

                        <!-- Analyse des 5 en jeu -->
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid ${hasLineups ? '#22c55e' : '#e2e8f0'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h3 style="margin: 0; color: ${hasLineups ? '#22c55e' : '#64748b'};">
                                        ${hasLineups ? '‚úÖ' : '‚ùå'} Analyse des 5 en jeu
                                    </h3>
                                    <small style="color: #94a3b8;">Combinaisons de 5 joueurs</small>
                                </div>
                                ${hasLineups ? `
                                    <span style="background: #dcfce7; color: #166534; padding: 5px 12px; border-radius: 20px; font-weight: bold;">
                                        ${currentMatch.stats_cinq_majeur.length} combinaisons
                                    </span>
                                ` : ''}
                            </div>

                            ${hasLineups ? `
                                <button class="btn btn-danger" onclick="deleteLineupsData(${currentMatch.id})" style="width: 100%;">
                                    üóëÔ∏è Supprimer les donn√©es
                                </button>
                            ` : `
                                <div style="margin-bottom: 10px;">
                                    <input type="file" id="analyse5File" accept=".pdf" style="width: 100%; margin-bottom: 10px;" />
                                </div>
                                <button class="btn btn-primary" onclick="uploadAnalyse5(${currentMatch.id})" style="width: 100%;">
                                    üì§ Importer Analyse des 5
                                </button>
                            `}
                            <div id="analyse5Message" class="message" style="margin-top: 10px;"></div>
                        </div>

                        <!-- Boxscore D√©taill√©e -->
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid ${hasAdvancedStats ? '#22c55e' : '#e2e8f0'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h3 style="margin: 0; color: ${hasAdvancedStats ? '#22c55e' : '#64748b'};">
                                        ${hasAdvancedStats ? '‚úÖ' : '‚ùå'} Boxscore D√©taill√©e
                                    </h3>
                                    <small style="color: #94a3b8;">Stats avanc√©es par p√©riode</small>
                                </div>
                            </div>

                            ${hasAdvancedStats ? `
                                <button class="btn btn-danger" onclick="deleteAdvancedStats(${currentMatch.id})" style="width: 100%;">
                                    üóëÔ∏è Supprimer les donn√©es
                                </button>
                            ` : `
                                <div style="margin-bottom: 10px;">
                                    <input type="file" id="boxscoreFile" accept=".pdf" style="width: 100%; margin-bottom: 10px;" />
                                </div>
                                <button class="btn btn-primary" onclick="uploadBoxscore(${currentMatch.id})" style="width: 100%;">
                                    üì§ Importer Boxscore D√©taill√©e
                                </button>
                            `}
                            <div id="boxscoreMessage" class="message" style="margin-top: 10px;"></div>
                        </div>

                    </div>
                </div>
            `;
        }

        // Rendu de l'analyse coach pour un match
        function renderCoachAnalysisForMatch() {
            // Le coaching IA sera ins√©r√© automatiquement via renderCoachingForMatch()
            return '<div id="coaching-section"></div>';
        }

        // Vue des combinaisons de 5 joueurs
        function renderLineups() {
            const lineups = currentMatch.stats_cinq_majeur || [];

            if (lineups.length === 0) {
                return `
                    <div class="tab-content active">
                        <div class="card" style="text-align: center; padding: 40px;">
                            <h2>üèÄ Combinaisons de 5</h2>
                            <p style="color: #666; margin-top: 20px;">
                                Aucune donn√©e de combinaisons disponible pour ce match.
                            </p>
                            <p style="color: #999; font-size: 0.9em; margin-top: 10px;">
                                Pour importer ces donn√©es, utilisez le fichier "Analyse_des_5_en_jeu" de la f√©d√©ration.
                            </p>
                        </div>
                    </div>
                `;
            }

            // S√©parer par √©quipe
            const team1 = currentMatch.equipe_domicile;
            const team2 = currentMatch.equipe_exterieur;

            const team1Lineups = lineups.filter(l => l.equipe && (l.equipe.includes('CSMF') || l.equipe.includes(team1.split(' ')[0])));
            const team2Lineups = lineups.filter(l => l.equipe && !l.equipe.includes('CSMF') && !l.equipe.includes(team1.split(' ')[0]));

            // D√©terminer quelle √©quipe est CSMF
            const csmfLineups = lineups.filter(l => l.equipe && l.equipe.includes('CSMF'));
            const otherLineups = lineups.filter(l => l.equipe && !l.equipe.includes('CSMF'));

            return `
                <div class="tab-content active">
                    <h2>ü¶Ü Combinaisons de 5 Joueurs</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Analyse de l'efficacit√© des diff√©rentes compositions utilis√©es pendant le match.
                    </p>

                    ${csmfLineups.length > 0 ? renderLineupsForTeam('CSMF PARIS', csmfLineups) : ''}
                    ${otherLineups.length > 0 ? renderLineupsForTeam(otherLineups[0]?.equipe || 'Adversaire', otherLineups) : ''}
                </div>
            `;
        }

        // Rendu des combinaisons pour une √©quipe
        function renderLineupsForTeam(teamName, lineups) {
            // Helper pour obtenir l'√©cart (compatible avec les deux formats)
            const getEcart = (l) => l.plus_minus ?? l.ecart ?? 0;
            const getDuree = (l) => l.duree_secondes ?? l.temps_secondes ?? 0;

            // Trier par √©cart (meilleur en premier)
            const sortedLineups = [...lineups].sort((a, b) => getEcart(b) - getEcart(a));

            // Calculer les stats globales
            const totalTime = lineups.reduce((sum, l) => sum + getDuree(l), 0);
            const bestLineup = sortedLineups[0];
            const worstLineup = sortedLineups[sortedLineups.length - 1];
            const bestEcart = bestLineup ? getEcart(bestLineup) : 0;
            const worstEcart = worstLineup ? getEcart(worstLineup) : 0;

            return `
                <div class="lineup-section">
                    <div class="team-header" style="margin-bottom: 20px;">
                        ${teamName} - ${lineups.length} combinaisons utilis√©es
                    </div>

                    <div class="message" style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em;">
                        ‚ÑπÔ∏è Certaines donn√©es peuvent √™tre incompl√®tes selon la qualit√© du fichier PDF source.
                    </div>

                    <!-- R√©sum√© -->
                    <div class="advanced-stats-grid" style="margin-bottom: 30px;">
                        <div class="advanced-stat-card">
                            <div class="advanced-stat-value">${lineups.length}</div>
                            <div class="advanced-stat-label">Combinaisons</div>
                        </div>
                        <div class="advanced-stat-card">
                            <div class="advanced-stat-value" style="color: #4ade80;">${bestLineup ? (bestEcart > 0 ? '+' : '') + bestEcart : '-'}</div>
                            <div class="advanced-stat-label">Meilleur √©cart</div>
                        </div>
                        <div class="advanced-stat-card">
                            <div class="advanced-stat-value" style="color: #f87171;">${worstLineup ? (worstEcart > 0 ? '+' : '') + worstEcart : '-'}</div>
                            <div class="advanced-stat-label">Pire √©cart</div>
                        </div>
                        <div class="advanced-stat-card">
                            <div class="advanced-stat-value">${Math.floor(totalTime / 60)}:${String(totalTime % 60).padStart(2, '0')}</div>
                            <div class="advanced-stat-label">Temps total</div>
                        </div>
                    </div>

                    <!-- Liste des combinaisons -->
                    <div class="lineup-filters">
                        <button class="lineup-filter-btn active" onclick="filterLineups('all', this)">Toutes</button>
                        <button class="lineup-filter-btn" onclick="filterLineups('positive', this)">‚úÖ Positives</button>
                        <button class="lineup-filter-btn" onclick="filterLineups('negative', this)">‚ùå N√©gatives</button>
                    </div>

                    <div class="lineups-container" data-team="${teamName}">
                        ${sortedLineups.map(lineup => renderLineupCard(lineup)).join('')}
                    </div>
                </div>
            `;
        }

        // Carte d'une combinaison
        function renderLineupCard(lineup) {
            // Mapper les champs de la base de donn√©es vers les noms attendus
            const ecart = lineup.plus_minus ?? lineup.ecart ?? 0;
            const dureeSecondes = lineup.duree_secondes ?? lineup.temps_secondes ?? 0;
            const scorePour = lineup.points_marques ?? lineup.score_pour ?? 0;
            const scoreContre = lineup.points_encaisses ?? lineup.score_contre ?? 0;

            // Calculer le temps de jeu format√©
            const minutes = Math.floor(dureeSecondes / 60);
            const secondes = dureeSecondes % 60;
            const tempsJeu = dureeSecondes > 0 ? `${minutes}:${String(secondes).padStart(2, '0')}` : null;

            // Calculer pts/min
            const ptsParMinute = dureeSecondes > 0 ? (scorePour / (dureeSecondes / 60)) : null;

            const ecartClass = ecart > 0 ? 'positive' : (ecart < 0 ? 'negative' : 'neutral');
            const ecartSign = ecart > 0 ? '+' : '';

            // Parser les joueurs depuis le format "1- NOM P/ 4- NOM C/ ..."
            const playersRaw = lineup.joueurs || '';
            const playersList = playersRaw.split('/').filter(p => p.trim()).map((p, index) => {
                const match = p.trim().match(/(\d+)-\s*([A-Z]+)/i);
                if (match && match[2]) {
                    return `#${match[1]} ${match[2]}`;
                } else if (p.trim()) {
                    return p.trim();
                } else {
                    return `<span class="player-name-fallback">üë§ Joueuse #${index + 1}</span>`;
                }
            });

            return `
                <div class="lineup-card ${ecartClass}" data-ecart="${ecart}">
                    <div class="lineup-header">
                        <div class="lineup-ecart ${ecartClass}">${ecartSign}${ecart}</div>
                        <div class="lineup-meta">
                            <span>‚è±Ô∏è ${tempsJeu || '--'}</span>
                            <span>üìä ${scorePour}-${scoreContre}</span>
                            <span>‚ö° ${ptsParMinute !== null ? ptsParMinute.toFixed(1) : '--'} pts/min</span>
                        </div>
                    </div>

                    <div class="lineup-players">
                        ${playersList.map(p => `<span class="lineup-player">${p}</span>`).join('')}
                    </div>

                    <div class="lineup-stats">
                        <div class="lineup-stat">
                            <div class="lineup-stat-value">${scorePour}</div>
                            <div class="lineup-stat-label">Points marqu√©s</div>
                        </div>
                        <div class="lineup-stat">
                            <div class="lineup-stat-value">${scoreContre}</div>
                            <div class="lineup-stat-label">Points encaiss√©s</div>
                        </div>
                        <div class="lineup-stat">
                            <div class="lineup-stat-value">${tempsJeu || '--'}</div>
                            <div class="lineup-stat-label">Temps de jeu</div>
                        </div>
                        <div class="lineup-stat">
                            <div class="lineup-stat-value">${ptsParMinute !== null ? ptsParMinute.toFixed(1) : '--'}</div>
                            <div class="lineup-stat-label">Pts/min</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Filtrer les combinaisons affich√©es
        function filterLineups(filter, btn) {
            // Mettre √† jour les boutons
            document.querySelectorAll('.lineup-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Filtrer les cartes
            document.querySelectorAll('.lineup-card').forEach(card => {
                const ecart = parseInt(card.dataset.ecart);
                if (filter === 'all') {
                    card.style.display = 'block';
                } else if (filter === 'positive' && ecart > 0) {
                    card.style.display = 'block';
                } else if (filter === 'negative' && ecart < 0) {
                    card.style.display = 'block';
                } else if (filter !== 'all') {
                    card.style.display = 'none';
                }
            });
        }

        // Vue joueuses par √©quipe (2 tableaux)
        function renderPlayersByTeam() {
            const players = currentMatch.stats_joueuses || [];

            // S√©parer par √©quipe
            const team1 = currentMatch.equipe_domicile;
            const team2 = currentMatch.equipe_exterieur;

            const team1Players = players.filter(p => p.equipe && p.equipe.includes(team1.split(' ')[0]));
            const team2Players = players.filter(p => p.equipe && !p.equipe.includes(team1.split(' ')[0]));

            return `
                <div class="tab-content active">
                    ${renderTeamTable(team1, team1Players)}
                    ${renderTeamTable(team2, team2Players)}
                </div>
            `;
        }

        // Tableau pour une √©quipe
        function renderTeamTable(teamName, players) {
            return `
                <div class="team-section">
                    <div class="team-header">
                        ${teamName}
                    </div>
                    <div class="scroll-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueuse</th>
                                    <th>Min</th>
                                    <th>PTS</th>
                                    <th>Tirs</th>
                                    <th>2pts</th>
                                    <th>3pts</th>
                                    <th>LF</th>
                                    <th>REB</th>
                                    <th>PD</th>
                                    <th>BP</th>
                                    <th>INT</th>
                                    <th>CTR</th>
                                    <th>F</th>
                                    <th>FP</th>
                                    <th>+/-</th>
                                    <th>EVAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${players.map(p => `
                                    <tr>
                                        <td><strong>#${p.numero || '?'}</strong> ${p.nom}</td>
                                        <td>${p.minutes || '-'}</td>
                                        <td><span class="stat-badge">${p.points || 0}</span></td>
                                        <td>${p.tirs_reussis || 0}/${p.tirs_tentes || 0}</td>
                                        <td>${p.tirs_2pts_reussis || 0}/${p.tirs_2pts_tentes || 0}</td>
                                        <td>${p.tirs_3pts_reussis || 0}/${p.tirs_3pts_tentes || 0}</td>
                                        <td>${p.lf_reussis || 0}/${p.lf_tentes || 0}</td>
                                        <td>${p.rebonds_total || 0}</td>
                                        <td>${p.passes_decisives || 0}</td>
                                        <td>${p.balles_perdues || 0}</td>
                                        <td>${p.interceptions || 0}</td>
                                        <td>${p.contres || 0}</td>
                                        <td>${p.fautes || 0}</td>
                                        <td>${p.fautes_provoquees || 0}</td>
                                        <td>${p.plus_moins || 0}</td>
                                        <td>${p.evaluation || 0}</td>
                                    </tr>
                                `).join('')}
                                ${(() => {
                                    // Calcul des totaux
                                    const totals = {
                                        points: players.reduce((sum, p) => sum + (p.points || 0), 0),
                                        tirs_reussis: players.reduce((sum, p) => sum + (p.tirs_reussis || 0), 0),
                                        tirs_tentes: players.reduce((sum, p) => sum + (p.tirs_tentes || 0), 0),
                                        tirs_2pts_reussis: players.reduce((sum, p) => sum + (p.tirs_2pts_reussis || 0), 0),
                                        tirs_2pts_tentes: players.reduce((sum, p) => sum + (p.tirs_2pts_tentes || 0), 0),
                                        tirs_3pts_reussis: players.reduce((sum, p) => sum + (p.tirs_3pts_reussis || 0), 0),
                                        tirs_3pts_tentes: players.reduce((sum, p) => sum + (p.tirs_3pts_tentes || 0), 0),
                                        lf_reussis: players.reduce((sum, p) => sum + (p.lf_reussis || 0), 0),
                                        lf_tentes: players.reduce((sum, p) => sum + (p.lf_tentes || 0), 0),
                                        rebonds: players.reduce((sum, p) => sum + (p.rebonds_total || 0), 0),
                                        passes: players.reduce((sum, p) => sum + (p.passes_decisives || 0), 0),
                                        pertes: players.reduce((sum, p) => sum + (p.balles_perdues || 0), 0),
                                        interceptions: players.reduce((sum, p) => sum + (p.interceptions || 0), 0),
                                        contres: players.reduce((sum, p) => sum + (p.contres || 0), 0),
                                        fautes: players.reduce((sum, p) => sum + (p.fautes || 0), 0),
                                        fautes_provoquees: players.reduce((sum, p) => sum + (p.fautes_provoquees || 0), 0),
                                        evaluation: players.reduce((sum, p) => sum + (p.evaluation || 0), 0)
                                    };
                                    return `
                                    <tr style="background: #f0f0f0; font-weight: bold; border-top: 2px solid #667eea;">
                                        <td>TOTAL √âQUIPE</td>
                                        <td>-</td>
                                        <td><span class="stat-badge">${totals.points}</span></td>
                                        <td>${totals.tirs_reussis}/${totals.tirs_tentes}</td>
                                        <td>${totals.tirs_2pts_reussis}/${totals.tirs_2pts_tentes}</td>
                                        <td>${totals.tirs_3pts_reussis}/${totals.tirs_3pts_tentes}</td>
                                        <td>${totals.lf_reussis}/${totals.lf_tentes}</td>
                                        <td>${totals.rebonds}</td>
                                        <td>${totals.passes}</td>
                                        <td>${totals.pertes}</td>
                                        <td>${totals.interceptions}</td>
                                        <td>${totals.contres}</td>
                                        <td>${totals.fautes}</td>
                                        <td>${totals.fautes_provoquees}</td>
                                        <td>-</td>
                                        <td>${totals.evaluation}</td>
                                    </tr>
                                    `;
                                })()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Vue CSMF - Rendu du contenu (synchrone, utilise le cache)
        function renderCsmfViewContent() {
            return `
                <div class="card">
                    <h2>üèÜ Statistiques Globales CSMF</h2>

                    ${renderMatchFilter()}

                    <div id="csmf-content">
                        ${csmfDataCache ? renderCsmfData(csmfDataCache) : '<div class="loading">‚è≥ Chargement des statistiques...</div>'}
                    </div>
                </div>
            `;
        }

        // Rendu des donn√©es CSMF
        function renderCsmfData(data) {
            return `
                ${renderCsmfSummary(data.players, data.teamStats)}
                ${renderCsmfPlayersTable(data.players)}
                ${renderCsmfBestLineups(data.allLineups || [])}
                ${renderCoachAnalysisGlobal(data.players)}
            `;
        }

        // Rendu des meilleures combinaisons de 5 CSMF
        function renderCsmfBestLineups(lineups) {
            if (!lineups || lineups.length === 0) {
                return `
                    <div class="card" style="margin-top: 30px;">
                        <h2>üèÄ Meilleures Combinaisons de 5</h2>
                        <p style="color: #666; text-align: center; padding: 20px;">
                            Aucune donn√©e de combinaisons disponible.<br>
                            <small>Importez les fichiers "Analyse_des_5_en_jeu" pour voir ces statistiques.</small>
                        </p>
                    </div>
                `;
            }

            // Fonction pour normaliser les joueurs d'une combinaison (ordre alphab√©tique des noms)
            function normalizeLineupKey(joueurs) {
                return joueurs.split('/').map(p => p.trim()).filter(p => p).sort().join('/');
            }

            // Agr√©ger les combinaisons identiques sur tous les matchs
            const lineupAggregates = {};
            lineups.forEach(l => {
                const key = normalizeLineupKey(l.joueurs);
                if (!lineupAggregates[key]) {
                    lineupAggregates[key] = {
                        joueurs: l.joueurs,
                        total_temps_secondes: 0,
                        total_score_pour: 0,
                        total_score_contre: 0,
                        total_ecart: 0,
                        matchs: [],
                        count: 0
                    };
                }
                // Compatibilit√© avec les deux formats de noms de champs
                lineupAggregates[key].total_temps_secondes += l.duree_secondes ?? l.temps_secondes ?? 0;
                lineupAggregates[key].total_score_pour += l.points_marques ?? l.score_pour ?? 0;
                lineupAggregates[key].total_score_contre += l.points_encaisses ?? l.score_contre ?? 0;
                lineupAggregates[key].total_ecart += l.plus_minus ?? l.ecart ?? 0;
                lineupAggregates[key].matchs.push(l.adversaire || 'Match');
                lineupAggregates[key].count++;
            });

            // Calculer les moyennes et transformer en array
            const aggregatedLineups = Object.values(lineupAggregates).map(agg => {
                const minutes = agg.total_temps_secondes / 60;
                return {
                    joueurs: agg.joueurs,
                    temps_total: agg.total_temps_secondes,
                    temps_display: `${Math.floor(minutes)}:${String(Math.round((minutes % 1) * 60)).padStart(2, '0')}`,
                    pts_pour: agg.total_score_pour,
                    pts_contre: agg.total_score_contre,
                    ecart_total: agg.total_ecart,
                    ecart_moyen: agg.count > 0 ? (agg.total_ecart / agg.count).toFixed(1) : 0,
                    pts_par_min: minutes > 0 ? (agg.total_score_pour / minutes).toFixed(2) : 0,
                    nb_matchs: agg.count,
                    matchs: [...new Set(agg.matchs)] // Unique adversaires
                };
            }).filter(l => l.temps_total >= 120); // Minimum 2 minutes de jeu pour √™tre significatif

            // Trier par √©cart moyen (moyenne sur tous les matchs)
            const sortedLineups = [...aggregatedLineups].sort((a, b) => parseFloat(b.ecart_moyen) - parseFloat(a.ecart_moyen));
            const bestLineups = sortedLineups.filter(l => parseFloat(l.ecart_moyen) > 0).slice(0, 5);
            const worstLineups = sortedLineups.filter(l => parseFloat(l.ecart_moyen) < 0).slice(-5).reverse();

            // Statistiques globales
            const totalCombinations = aggregatedLineups.length;
            const positiveCombinations = aggregatedLineups.filter(l => parseFloat(l.ecart_moyen) > 0).length;
            const negativeCombinations = aggregatedLineups.filter(l => parseFloat(l.ecart_moyen) < 0).length;
            const avgEcart = aggregatedLineups.length > 0
                ? aggregatedLineups.reduce((sum, l) => sum + parseFloat(l.ecart_moyen), 0) / aggregatedLineups.length
                : 0;

            // Fonction pour formatter une carte de combinaison agr√©g√©e
            function renderAggregatedLineupCard(lineup, isPositive) {
                const color = isPositive ? '#16a34a' : '#dc2626';
                const bgColor = isPositive ? 'rgba(74, 222, 128, 0.15)' : 'rgba(248, 113, 113, 0.15)';
                const ecartMoyen = parseFloat(lineup.ecart_moyen);

                // Extraire les noms courts des joueuses
                const players = (lineup.joueurs || '').split('/').map((p, index) => {
                    const match = p.trim().match(/(\d+)-\s*([A-Z]+)/i);
                    if (match && match[2]) {
                        return match[2];
                    } else if (p.trim()) {
                        return p.trim();
                    } else {
                        return `Joueuse #${index + 1}`;
                    }
                }).filter(p => p).join(' ‚Ä¢ ');

                return `
                    <div style="background: ${bgColor}; border-left: 4px solid ${color}; padding: 15px; margin-bottom: 12px; border-radius: 0 10px 10px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="color: ${color}; font-weight: bold; font-size: 22px;">
                                    ${ecartMoyen >= 0 ? '+' : ''}${lineup.ecart_moyen}
                                    <span style="font-size: 12px; color: #64748b; font-weight: normal;">moy/match</span>
                                </div>
                                <div style="color: #1e293b; margin-top: 8px; font-size: 14px; font-weight: 500;">${players}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #475569; font-size: 12px;">${lineup.nb_matchs} match${lineup.nb_matchs > 1 ? 's' : ''}</div>
                                <div style="color: #475569; font-size: 12px;">${lineup.temps_display} total</div>
                                <div style="color: #64748b; font-size: 11px; margin-top: 4px;">${lineup.pts_par_min} pts/min</div>
                            </div>
                        </div>
                        <div style="color: #64748b; font-size: 11px; margin-top: 8px;">
                            √âcart total: ${lineup.ecart_total >= 0 ? '+' : ''}${lineup.ecart_total} (${lineup.pts_pour}-${lineup.pts_contre})
                        </div>
                    </div>
                `;
            }

            return `
                <div class="card" style="margin-top: 30px;">
                    <h2>ü¶Ü Analyse des Combinaisons de 5</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        üìä Moyennes calcul√©es sur l'ensemble des matchs (min. 2 min de jeu par combinaison)
                    </p>

                    <!-- Stats globales -->
                    <div class="advanced-stats-grid">
                        <div class="advanced-stat-card">
                            <div class="advanced-stat-value">${totalCombinations}</div>
                            <div class="advanced-stat-label">Combinaisons uniques</div>
                        </div>
                        <div class="advanced-stat-card">
                            <div class="advanced-stat-value" style="color: #16a34a;">${positiveCombinations}</div>
                            <div class="advanced-stat-label">Moy. positive</div>
                        </div>
                        <div class="advanced-stat-card">
                            <div class="advanced-stat-value" style="color: #dc2626;">${negativeCombinations}</div>
                            <div class="advanced-stat-label">Moy. n√©gative</div>
                        </div>
                        <div class="advanced-stat-card">
                            <div class="advanced-stat-value" style="color: ${avgEcart >= 0 ? '#16a34a' : '#dc2626'};">${avgEcart >= 0 ? '+' : ''}${avgEcart.toFixed(1)}</div>
                            <div class="advanced-stat-label">√âcart moyen global</div>
                        </div>
                    </div>

                    <!-- Meilleures combinaisons -->
                    ${bestLineups.length > 0 ? `
                        <h3 style="margin-top: 30px; color: #16a34a;">‚úÖ Top 5 Meilleures Combinaisons (moyenne)</h3>
                        <div style="margin-top: 15px;">
                            ${bestLineups.map(l => renderAggregatedLineupCard(l, true)).join('')}
                        </div>
                    ` : ''}

                    <!-- Pires combinaisons -->
                    ${worstLineups.length > 0 ? `
                        <h3 style="margin-top: 30px; color: #dc2626;">‚ö†Ô∏è Combinaisons √† √©viter (moyenne)</h3>
                        <div style="margin-top: 15px;">
                            ${worstLineups.map(l => renderAggregatedLineupCard(l, false)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Rendu de l'analyse coach pour la vue globale CSMF
        function renderCoachAnalysisGlobal(csmfData) {
            const nbMatchs = selectedMatchesForCsmf.length;
            if (nbMatchs === 0) return '';

            // Le coaching IA global sera ins√©r√© automatiquement via renderGlobalCoaching()
            return '<div id="global-coaching-section"></div>';
        }

        // Filtre de matchs pour vue CSMF
        function renderMatchFilter() {
            return `
                <div class="filters">
                    <div class="filter-group">
                        <label>Filtrer par match(s) :</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox"
                                       ${selectedMatchesForCsmf.length === allMatches.length ? 'checked' : ''}
                                       onchange="toggleAllMatches(this)">
                                Tous les matchs
                            </label>
                            ${allMatches.map(m => `
                                <label class="checkbox-label">
                                    <input type="checkbox"
                                           value="${m.id}"
                                           ${selectedMatchesForCsmf.includes(m.id) ? 'checked' : ''}
                                           onchange="toggleMatch(${m.id})">
                                    ${m.journee ? `[${m.journee}] ` : ''}${getShortTeamName(m.equipe_domicile)} vs ${getShortTeamName(m.equipe_exterieur)} (${formatDateFrench(m.date, 'short')})
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Charger les donn√©es CSMF
        async function loadCsmfData() {
            const csmfPlayers = {};
            let totalPointsEncaisses = 0;
            let totalRebondsOffAdversaires = 0;
            let totalLFAdversaires = 0;
            let totalLFReussisAdversaires = 0;

            console.log('=== DEBUT CHARGEMENT CSMF ===');

            // Fonction helper pour extraire le nom de famille
            function getLastName(fullName) {
                if (!fullName) return '';
                const parts = fullName.trim().split(/\s+/);
                return parts[parts.length - 1]; // Le dernier mot est le nom de famille
            }

            for (const matchId of selectedMatchesForCsmf) {
                const response = await fetch(`${API_URL}/matches/${matchId}`);
                const result = await response.json();

                if (result.success) {
                    const match = result.data;
                    const players = match.stats_joueuses || [];

                    console.log(`\n--- Match ${matchId} ---`);
                    console.log(`Total joueuses dans le match: ${players.length}`);

                    // Collecter les stats d'√©quipe
                    const isCsmfDomicile = match.equipe_domicile.includes('CSMF');
                    totalPointsEncaisses += isCsmfDomicile ? match.score_exterieur : match.score_domicile;

                    const adversaireStats = match.stats_equipes.find(e => !e.equipe.includes('CSMF'));
                    if (adversaireStats) {
                        totalRebondsOffAdversaires += adversaireStats.rebonds_offensifs || 0;
                        totalLFAdversaires += adversaireStats.lf_tentes || 0;
                        totalLFReussisAdversaires += adversaireStats.lf_reussis || 0;
                    }

                    // Pour √©viter les doublons dans un m√™me match
                    const processedInThisMatch = new Set();
                    let csmfCount = 0;
                    let totalPointsThisMatch = 0;

                    // Filtrer les joueuses CSMF (exclure les lignes TOTAL)
                    players.forEach(p => {
                        // Debug: afficher toutes les joueuses CSMF
                        if (p.equipe && p.equipe.includes('CSMF')) {
                            console.log(`  CSMF trouv√©e: ${p.nom} - ${p.points} pts - Equipe: ${p.equipe}`);
                        }

                        // Exclure les lignes qui ne sont pas de vraies joueuses
                        const isRealPlayer = p.nom &&
                                           !p.nom.toLowerCase().includes('total') &&
                                           !p.nom.toLowerCase().includes('totaux') &&
                                           !p.nom.toLowerCase().includes('equipe') &&
                                           p.nom.trim() !== '' &&
                                           p.nom.length > 2;

                        if (p.equipe && p.equipe.includes('CSMF') && isRealPlayer) {
                            // Pour CSMF : utiliser le nom de famille comme cl√© d'agr√©gation
                            const lastName = getLastName(p.nom);

                            // V√©rifier si cette joueuse (par nom de famille) a d√©j√† √©t√© trait√©e dans ce match
                            if (processedInThisMatch.has(lastName)) {
                                console.log(`  ‚ö†Ô∏è DOUBLON DETECTE (m√™me nom de famille): ${p.nom}`);
                                return; // Skip les doublons
                            }
                            processedInThisMatch.add(lastName);
                            csmfCount++;
                            totalPointsThisMatch += p.points || 0;

                            // Utiliser le nom de famille comme cl√© pour l'agr√©gation
                            if (!csmfPlayers[lastName]) {
                                csmfPlayers[lastName] = {
                                    nom: p.nom, // Garder le premier pr√©nom complet rencontr√©
                                    matchs: 0,
                                    points: 0,
                                    rebonds: 0,
                                    rebonds_off: 0,
                                    rebonds_def: 0,
                                    passes: 0,
                                    tirs_reussis: 0,
                                    tirs_tentes: 0,
                                    tirs_2pts_reussis: 0,
                                    tirs_2pts_tentes: 0,
                                    tirs_3pts_reussis: 0,
                                    tirs_3pts_tentes: 0,
                                    lf_reussis: 0,
                                    lf_tentes: 0,
                                    balles_perdues: 0,
                                    interceptions: 0,
                                    contres: 0,
                                    fautes: 0,
                                    fautes_provoquees: 0,
                                    plus_moins: 0,
                                    evaluation: 0
                                };
                                console.log(`  ‚ú® Premi√®re occurrence: ${p.nom} ‚Üí cl√©: ${lastName}`);
                            } else {
                                console.log(`  üîÑ Fusion avec ${csmfPlayers[lastName].nom}: ${p.nom} - ${p.points} pts`);
                            }

                            console.log(`  ‚úì Ajout: ${p.nom} - ${p.points} pts`);

                            csmfPlayers[lastName].matchs++;
                            csmfPlayers[lastName].points += p.points || 0;
                            csmfPlayers[lastName].rebonds += p.rebonds_total || 0;
                            csmfPlayers[lastName].rebonds_off += p.rebonds_offensifs || 0;
                            csmfPlayers[lastName].rebonds_def += p.rebonds_defensifs || 0;
                            csmfPlayers[lastName].passes += p.passes_decisives || 0;
                            csmfPlayers[lastName].tirs_reussis += p.tirs_reussis || 0;
                            csmfPlayers[lastName].tirs_tentes += p.tirs_tentes || 0;
                            csmfPlayers[lastName].tirs_2pts_reussis += p.tirs_2pts_reussis || 0;
                            csmfPlayers[lastName].tirs_2pts_tentes += p.tirs_2pts_tentes || 0;
                            csmfPlayers[lastName].tirs_3pts_reussis += p.tirs_3pts_reussis || 0;
                            csmfPlayers[lastName].tirs_3pts_tentes += p.tirs_3pts_tentes || 0;
                            csmfPlayers[lastName].lf_reussis += p.lf_reussis || 0;
                            csmfPlayers[lastName].lf_tentes += p.lf_tentes || 0;
                            csmfPlayers[lastName].balles_perdues += p.balles_perdues || 0;
                            csmfPlayers[lastName].interceptions += p.interceptions || 0;
                            csmfPlayers[lastName].contres += p.contres || 0;
                            csmfPlayers[lastName].fautes += p.fautes || 0;
                            csmfPlayers[lastName].fautes_provoquees += p.fautes_provoquees || 0;
                            csmfPlayers[lastName].plus_moins += p.plus_moins || 0;
                            csmfPlayers[lastName].evaluation += p.evaluation || 0;
                        }
                    });

                    console.log(`Joueuses CSMF trait√©es: ${csmfCount}`);
                    console.log(`Total points CSMF ce match: ${totalPointsThisMatch}`);
                }
            }

            // Charger les combinaisons de 5 pour tous les matchs s√©lectionn√©s
            let allLineups = [];
            for (const matchId of selectedMatchesForCsmf) {
                try {
                    const lineupsResponse = await fetch(`${API_URL}/matches/${matchId}/lineups`);
                    const lineupsResult = await lineupsResponse.json();
                    if (lineupsResult.success && lineupsResult.data) {
                        // Filtrer uniquement les combinaisons CSMF
                        const csmfLineups = lineupsResult.data.filter(l => l.equipe && l.equipe.includes('CSMF'));
                        allLineups = allLineups.concat(csmfLineups);
                    }
                } catch (e) {
                    // Les combinaisons ne sont pas disponibles pour ce match
                }
            }

            const finalData = Object.values(csmfPlayers);
            const totalPoints = finalData.reduce((sum, p) => sum + p.points, 0);
            console.log(`\n=== RESULTAT FINAL ===`);
            console.log(`Total joueuses: ${finalData.length}`);
            console.log(`Total points: ${totalPoints}`);
            console.log(`Total combinaisons 5: ${allLineups.length}`);
            console.log('======================\n');

            return {
                players: finalData,
                teamStats: {
                    totalPointsEncaisses,
                    totalRebondsOffAdversaires,
                    totalLFAdversaires,
                    totalLFReussisAdversaires
                },
                allLineups: allLineups
            };
        }

        // R√©sum√© CSMF
        function renderCsmfSummary(csmfData, teamStats) {
            const totalPoints = csmfData.reduce((sum, p) => sum + p.points, 0);
            const totalPasses = csmfData.reduce((sum, p) => sum + p.passes, 0);
            const totalBP = csmfData.reduce((sum, p) => sum + p.balles_perdues, 0);
            const totalInterceptions = csmfData.reduce((sum, p) => sum + p.interceptions, 0);
            const totalRebondsOff = csmfData.reduce((sum, p) => sum + p.rebonds_off, 0);
            const totalRebondsDef = csmfData.reduce((sum, p) => sum + p.rebonds_def, 0);
            const totalFautes = csmfData.reduce((sum, p) => sum + p.fautes, 0);
            const totalFautesProvoquees = csmfData.reduce((sum, p) => sum + p.fautes_provoquees, 0);
            const nbMatchs = selectedMatchesForCsmf.length;

            // Calculer les pourcentages de r√©ussite globaux
            const total2ptsReussis = csmfData.reduce((sum, p) => sum + p.tirs_2pts_reussis, 0);
            const total2ptsTentes = csmfData.reduce((sum, p) => sum + p.tirs_2pts_tentes, 0);
            const pct2pts = total2ptsTentes > 0 ? ((total2ptsReussis / total2ptsTentes) * 100).toFixed(1) : 0;

            const total3ptsReussis = csmfData.reduce((sum, p) => sum + p.tirs_3pts_reussis, 0);
            const total3ptsTentes = csmfData.reduce((sum, p) => sum + p.tirs_3pts_tentes, 0);
            const pct3pts = total3ptsTentes > 0 ? ((total3ptsReussis / total3ptsTentes) * 100).toFixed(1) : 0;

            const totalLFReussis = csmfData.reduce((sum, p) => sum + p.lf_reussis, 0);
            const totalLFTentes = csmfData.reduce((sum, p) => sum + p.lf_tentes, 0);
            const pctLF = totalLFTentes > 0 ? ((totalLFReussis / totalLFTentes) * 100).toFixed(1) : 0;

            // Stats adversaires
            const pctLFAdversaires = teamStats.totalLFAdversaires > 0 ?
                ((teamStats.totalLFReussisAdversaires / teamStats.totalLFAdversaires) * 100).toFixed(1) : 0;

            return `
                <div class="summary-stats">
                    <h3>üìä R√©sum√© sur ${nbMatchs} match(s)</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="label">Moy Points/Match</div>
                            <div class="value">${nbMatchs > 0 ? (totalPoints / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Points Encaiss√©s</div>
                            <div class="value">${nbMatchs > 0 ? (teamStats.totalPointsEncaisses / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Passes D√©cisives</div>
                            <div class="value">${nbMatchs > 0 ? (totalPasses / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Interceptions</div>
                            <div class="value">${nbMatchs > 0 ? (totalInterceptions / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Balles Perdues</div>
                            <div class="value">${nbMatchs > 0 ? (totalBP / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Rebonds Offensifs</div>
                            <div class="value">${nbMatchs > 0 ? (totalRebondsOff / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Rebonds D√©fensifs</div>
                            <div class="value">${nbMatchs > 0 ? (totalRebondsDef / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Reb Off Adversaires</div>
                            <div class="value">${nbMatchs > 0 ? (teamStats.totalRebondsOffAdversaires / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Fautes Commises</div>
                            <div class="value">${nbMatchs > 0 ? (totalFautes / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy Fautes Provoqu√©es</div>
                            <div class="value">${nbMatchs > 0 ? (totalFautesProvoquees / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">% R√©ussite 2pts</div>
                            <div class="value">${pct2pts}%<br><small style="font-size: 0.8em; opacity: 0.8;">${total2ptsReussis}/${total2ptsTentes}</small></div>
                        </div>
                        <div class="summary-item">
                            <div class="label">% R√©ussite 3pts</div>
                            <div class="value">${pct3pts}%<br><small style="font-size: 0.8em; opacity: 0.8;">${total3ptsReussis}/${total3ptsTentes}</small></div>
                        </div>
                        <div class="summary-item">
                            <div class="label">% R√©ussite LF</div>
                            <div class="value">${pctLF}%<br><small style="font-size: 0.8em; opacity: 0.8;">${totalLFReussis}/${totalLFTentes}</small></div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Moy LF Adversaires</div>
                            <div class="value">${nbMatchs > 0 ? (teamStats.totalLFAdversaires / nbMatchs).toFixed(1) : 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">% R√©ussite LF Adversaires</div>
                            <div class="value">${pctLFAdversaires}%</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Joueuses</div>
                            <div class="value">${csmfData.length}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Tableau joueuses CSMF
        function renderCsmfPlayersTable(csmfData) {
            // Fonction pour obtenir la valeur de tri
            const getSortValue = (player, column) => {
                const m = player.matchs || 1;
                switch(column) {
                    case 'nom': return player.nom.toLowerCase();
                    case 'matchs': return player.matchs;
                    case 'evaluation': return player.evaluation / m;
                    case 'points': return player.points / m;
                    case 'tirs': return player.tirs_tentes > 0 ? player.tirs_reussis / player.tirs_tentes : 0;
                    case 'pct2pts': return player.tirs_2pts_tentes > 0 ? player.tirs_2pts_reussis / player.tirs_2pts_tentes : 0;
                    case 'pct3pts': return player.tirs_3pts_tentes > 0 ? player.tirs_3pts_reussis / player.tirs_3pts_tentes : 0;
                    case 'pctlf': return player.lf_tentes > 0 ? player.lf_reussis / player.lf_tentes : 0;
                    case 'rebonds': return player.rebonds / m;
                    case 'rebonds_off': return player.rebonds_off / m;
                    case 'rebonds_def': return player.rebonds_def / m;
                    case 'passes': return player.passes / m;
                    case 'balles_perdues': return player.balles_perdues / m;
                    case 'interceptions': return player.interceptions / m;
                    case 'contres': return player.contres / m;
                    case 'fautes': return player.fautes / m;
                    case 'fautes_provoquees': return player.fautes_provoquees / m;
                    case 'plus_moins': return player.plus_moins / m;
                    default: return player.evaluation / m;
                }
            };

            // Trier selon la colonne et direction actuelles
            const sortedPlayers = [...csmfData].sort((a, b) => {
                const valA = getSortValue(a, csmfSortColumn);
                const valB = getSortValue(b, csmfSortColumn);

                if (typeof valA === 'string') {
                    return csmfSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return csmfSortDirection === 'asc' ? valA - valB : valB - valA;
            });

            // Calculer les totaux pour la ligne TOTAL
            const totals = {
                matchs: sortedPlayers.reduce((sum, p) => Math.max(sum, p.matchs), 0),
                points: sortedPlayers.reduce((sum, p) => sum + p.points, 0),
                tirs_reussis: sortedPlayers.reduce((sum, p) => sum + p.tirs_reussis, 0),
                tirs_tentes: sortedPlayers.reduce((sum, p) => sum + p.tirs_tentes, 0),
                tirs_2pts_reussis: sortedPlayers.reduce((sum, p) => sum + p.tirs_2pts_reussis, 0),
                tirs_2pts_tentes: sortedPlayers.reduce((sum, p) => sum + p.tirs_2pts_tentes, 0),
                tirs_3pts_reussis: sortedPlayers.reduce((sum, p) => sum + p.tirs_3pts_reussis, 0),
                tirs_3pts_tentes: sortedPlayers.reduce((sum, p) => sum + p.tirs_3pts_tentes, 0),
                lf_reussis: sortedPlayers.reduce((sum, p) => sum + p.lf_reussis, 0),
                lf_tentes: sortedPlayers.reduce((sum, p) => sum + p.lf_tentes, 0),
                rebonds: sortedPlayers.reduce((sum, p) => sum + p.rebonds, 0),
                rebonds_off: sortedPlayers.reduce((sum, p) => sum + p.rebonds_off, 0),
                rebonds_def: sortedPlayers.reduce((sum, p) => sum + p.rebonds_def, 0),
                passes: sortedPlayers.reduce((sum, p) => sum + p.passes, 0),
                balles_perdues: sortedPlayers.reduce((sum, p) => sum + p.balles_perdues, 0),
                interceptions: sortedPlayers.reduce((sum, p) => sum + p.interceptions, 0),
                contres: sortedPlayers.reduce((sum, p) => sum + p.contres, 0),
                fautes: sortedPlayers.reduce((sum, p) => sum + p.fautes, 0),
                fautes_provoquees: sortedPlayers.reduce((sum, p) => sum + p.fautes_provoquees, 0),
                plus_moins: sortedPlayers.reduce((sum, p) => sum + p.plus_moins, 0),
                evaluation: sortedPlayers.reduce((sum, p) => sum + p.evaluation, 0)
            };

            // Helper pour g√©n√©rer la classe de tri
            const sortClass = (col) => {
                if (csmfSortColumn === col) {
                    return `sortable sort-${csmfSortDirection}`;
                }
                return 'sortable';
            };

            return `
                <h2 style="margin-top: 30px;">Statistiques D√©taill√©es des Joueuses CSMF</h2>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">üí° Cliquez sur les en-t√™tes de colonnes pour trier</p>
                <div class="scroll-table">
                    <table id="csmf-stats-table">
                        <thead>
                            <tr>
                                <th class="${sortClass('nom')}" onclick="sortCsmfTable('nom')">Joueuse</th>
                                <th class="${sortClass('matchs')}" onclick="sortCsmfTable('matchs')">Matchs</th>
                                <th class="${sortClass('evaluation')}" onclick="sortCsmfTable('evaluation')">EVAL</th>
                                <th class="${sortClass('points')}" onclick="sortCsmfTable('points')">Moy PTS</th>
                                <th class="${sortClass('tirs')}" onclick="sortCsmfTable('tirs')">Tirs</th>
                                <th class="${sortClass('tirs')}" onclick="sortCsmfTable('tirs')">%</th>
                                <th class="${sortClass('pct2pts')}" onclick="sortCsmfTable('pct2pts')">%2pts</th>
                                <th class="${sortClass('pct3pts')}" onclick="sortCsmfTable('pct3pts')">%3pts</th>
                                <th class="${sortClass('pctlf')}" onclick="sortCsmfTable('pctlf')">%LF</th>
                                <th class="${sortClass('rebonds')}" onclick="sortCsmfTable('rebonds')">Moy REB</th>
                                <th class="${sortClass('rebonds_off')}" onclick="sortCsmfTable('rebonds_off')">Moy RO</th>
                                <th class="${sortClass('rebonds_def')}" onclick="sortCsmfTable('rebonds_def')">Moy RD</th>
                                <th class="${sortClass('passes')}" onclick="sortCsmfTable('passes')">Moy PD</th>
                                <th class="${sortClass('balles_perdues')}" onclick="sortCsmfTable('balles_perdues')">Moy BP</th>
                                <th class="${sortClass('interceptions')}" onclick="sortCsmfTable('interceptions')">Moy INT</th>
                                <th class="${sortClass('contres')}" onclick="sortCsmfTable('contres')">Moy CTR</th>
                                <th class="${sortClass('fautes')}" onclick="sortCsmfTable('fautes')">Moy F</th>
                                <th class="${sortClass('fautes_provoquees')}" onclick="sortCsmfTable('fautes_provoquees')">Moy FP</th>
                                <th class="${sortClass('plus_moins')}" onclick="sortCsmfTable('plus_moins')">Moy +/-</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedPlayers.map(p => {
                                const pctTirs = p.tirs_tentes > 0 ? ((p.tirs_reussis / p.tirs_tentes) * 100).toFixed(1) : 0;
                                const pct2pts = p.tirs_2pts_tentes > 0 ? ((p.tirs_2pts_reussis / p.tirs_2pts_tentes) * 100).toFixed(1) : 0;
                                const pct3pts = p.tirs_3pts_tentes > 0 ? ((p.tirs_3pts_reussis / p.tirs_3pts_tentes) * 100).toFixed(1) : 0;
                                const pctLF = p.lf_tentes > 0 ? ((p.lf_reussis / p.lf_tentes) * 100).toFixed(1) : 0;
                                const moyEval = (p.evaluation / p.matchs).toFixed(1);
                                return `
                                    <tr onclick="showPlayerDetails('${p.nom}')" style="cursor: pointer;">
                                        <td><strong>${p.nom}</strong></td>
                                        <td>${p.matchs}</td>
                                        <td><span class="stat-badge">${moyEval}</span></td>
                                        <td>${(p.points / p.matchs).toFixed(1)}</td>
                                        <td>${p.tirs_reussis}/${p.tirs_tentes}</td>
                                        <td>${pctTirs}%</td>
                                        <td>${pct2pts}%</td>
                                        <td>${pct3pts}%</td>
                                        <td>${pctLF}%</td>
                                        <td>${(p.rebonds / p.matchs).toFixed(1)}</td>
                                        <td>${(p.rebonds_off / p.matchs).toFixed(1)}</td>
                                        <td>${(p.rebonds_def / p.matchs).toFixed(1)}</td>
                                        <td>${(p.passes / p.matchs).toFixed(1)}</td>
                                        <td>${(p.balles_perdues / p.matchs).toFixed(1)}</td>
                                        <td>${(p.interceptions / p.matchs).toFixed(1)}</td>
                                        <td>${(p.contres / p.matchs).toFixed(1)}</td>
                                        <td>${(p.fautes / p.matchs).toFixed(1)}</td>
                                        <td>${(p.fautes_provoquees / p.matchs).toFixed(1)}</td>
                                        <td>${(p.plus_moins / p.matchs).toFixed(1)}</td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="background: #667eea; color: white; font-weight: bold; border-top: 3px solid #333;">
                                <td>TOTAL</td>
                                <td>${totals.matchs}</td>
                                <td><span class="stat-badge" style="background: #ffd700; color: #333;">${(totals.evaluation / totals.matchs).toFixed(1)}</span></td>
                                <td>${(totals.points / totals.matchs).toFixed(1)}</td>
                                <td>${totals.tirs_reussis}/${totals.tirs_tentes}</td>
                                <td>${totals.tirs_tentes > 0 ? ((totals.tirs_reussis / totals.tirs_tentes) * 100).toFixed(1) : 0}%</td>
                                <td>${totals.tirs_2pts_tentes > 0 ? ((totals.tirs_2pts_reussis / totals.tirs_2pts_tentes) * 100).toFixed(1) : 0}%</td>
                                <td>${totals.tirs_3pts_tentes > 0 ? ((totals.tirs_3pts_reussis / totals.tirs_3pts_tentes) * 100).toFixed(1) : 0}%</td>
                                <td>${totals.lf_tentes > 0 ? ((totals.lf_reussis / totals.lf_tentes) * 100).toFixed(1) : 0}%</td>
                                <td>${(totals.rebonds / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.rebonds_off / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.rebonds_def / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.passes / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.balles_perdues / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.interceptions / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.contres / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.fautes / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.fautes_provoquees / totals.matchs).toFixed(1)}</td>
                                <td>${(totals.plus_moins / totals.matchs).toFixed(1)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Fonction de tri du tableau CSMF
        function sortCsmfTable(column) {
            // Si m√™me colonne, inverser la direction
            if (csmfSortColumn === column) {
                csmfSortDirection = csmfSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                csmfSortColumn = column;
                // Par d√©faut : desc pour les stats num√©riques, asc pour le nom
                csmfSortDirection = column === 'nom' ? 'asc' : 'desc';
            }

            // Re-render la vue CSMF
            if (csmfDataCache) {
                render();
            }
        }

        // Vue statistiques
        function renderStats() {
            const totalPoints = currentMatch.score_domicile + currentMatch.score_exterieur;
            const ecart = Math.abs(currentMatch.score_domicile - currentMatch.score_exterieur);

            return `
                <div class="tab-content active">
                    <h2>Statistiques Globales du Match</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Affluence</h3>
                            <div class="value">${currentMatch.affluence || 'N/A'}</div>
                            <small>spectateurs</small>
                        </div>
                        <div class="stat-card">
                            <h3>Total Points</h3>
                            <div class="value">${totalPoints}</div>
                            <small>marqu√©s au total</small>
                        </div>
                        <div class="stat-card">
                            <h3>√âcart</h3>
                            <div class="value">${ecart}</div>
                            <small>points de diff√©rence</small>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">Informations du Match</h2>
                    <table>
                        <tr>
                            <th>Match No.</th>
                            <td>${currentMatch.match_no || 'N/A'}</td>
                        </tr>
                        <tr>
                            <th>Date</th>
                            <td>${currentMatch.date}</td>
                        </tr>
                        <tr>
                            <th>Heure</th>
                            <td>${currentMatch.heure}</td>
                        </tr>
                        <tr>
                            <th>√âquipe Domicile</th>
                            <td>${currentMatch.equipe_domicile}</td>
                        </tr>
                        <tr>
                            <th>√âquipe Ext√©rieur</th>
                            <td>${currentMatch.equipe_exterieur}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        // Changer d'onglet (pour la vue par match)
        function switchTab(tab) {
            currentTab = tab;
            render();
        }

        // Toggle tous les matchs
        async function toggleAllMatches(checkbox) {
            if (checkbox.checked) {
                selectedMatchesForCsmf = allMatches.map(m => m.id);
            } else {
                selectedMatchesForCsmf = [];
            }
            await loadCsmfDataAsync();
        }

        // Toggle un match
        async function toggleMatch(matchId) {
            const index = selectedMatchesForCsmf.indexOf(matchId);
            if (index > -1) {
                selectedMatchesForCsmf.splice(index, 1);
            } else {
                selectedMatchesForCsmf.push(matchId);
            }
            await loadCsmfDataAsync();
        }

        // Attacher les √©v√©nements
        function attachEventListeners() {
            // Les √©v√©nements sont g√©r√©s via onclick dans le HTML
        }


        // ========== GESTION AUTRES √âQUIPES ==========

        // Charger tous les matchs non-CSMF
        async function loadNonCsmfMatches() {
            const response = await fetch(`${API_URL}/matches`);
            const result = await response.json();

            if (result.success) {
                // Filtrer pour ne garder que les matchs sans CSMF
                allNonCsmfMatches = result.data.filter(m =>
                    !m.equipe_domicile.includes('CSMF') &&
                    !m.equipe_exterieur.includes('CSMF')
                );
            }
        }

        // Upload d'un match non-CSMF avec contr√¥le
        async function uploadNonCsmfMatch() {
            const fileInput = document.getElementById('pdfFileAutres');
            const messageDiv = document.getElementById('uploadMessageAutres');

            if (!fileInput.files || fileInput.files.length === 0) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Veuillez s√©lectionner un fichier PDF';
                return;
            }

            const file = fileInput.files[0];

            if (!file.name.toLowerCase().endsWith('.pdf')) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Seuls les fichiers PDF sont accept√©s';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            messageDiv.className = 'message show';
            messageDiv.innerHTML = '<span class="loading"></span> V√©rification et import...';

            try {
                const response = await fetch(`${API_URL}/matches/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // V√©rifier si le match contient CSMF
                    const match = result.match;
                    if (match.equipe_domicile.includes('CSMF') || match.equipe_exterieur.includes('CSMF')) {
                        // Supprimer le match de la base
                        await fetch(`${API_URL}/matches/${result.match_id}`, { method: 'DELETE' });

                        messageDiv.className = 'message error show';
                        messageDiv.textContent = '‚ùå Ce match contient le CSMF ! Utilisez l\'onglet "Analyse par Match"';
                        fileInput.value = '';
                        return;
                    }

                    messageDiv.className = 'message success show';
                    messageDiv.textContent = '‚úÖ Match import√© avec succ√®s !';
                    fileInput.value = '';

                    await loadNonCsmfMatches();
                    render();

                    setTimeout(() => {
                        messageDiv.className = 'message';
                    }, 3000);
                } else {
                    messageDiv.className = 'message error show';
                    messageDiv.textContent = '‚ùå Erreur: ' + result.error;
                }
            } catch (error) {
                messageDiv.className = 'message error show';
                messageDiv.textContent = '‚ùå Erreur lors de l\'upload: ' + error.message;
            }
        }

        // Supprimer un match non-CSMF
        async function deleteNonCsmfMatch(matchId, event) {
            event.stopPropagation();

            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce match ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/matches/${matchId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Match supprim√© avec succ√®s !');
                    await loadNonCsmfMatches();

                    // R√©initialiser si c'√©tait l'√©quipe s√©lectionn√©e
                    if (selectedTeam) {
                        await selectTeam(selectedTeam);
                    }

                    render();
                } else {
                    alert('‚ùå Erreur: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors de la suppression: ' + error.message);
            }
        }

        // Obtenir la liste des √©quipes uniques
        function getUniqueTeams() {
            const teams = new Set();
            allNonCsmfMatches.forEach(m => {
                teams.add(m.equipe_domicile);
                teams.add(m.equipe_exterieur);
            });
            return Array.from(teams).sort();
        }

        // S√©lectionner une √©quipe
        async function selectTeam(teamName) {
            selectedTeam = teamName;

            // Charger les matchs de cette √©quipe
            teamMatches = allNonCsmfMatches.filter(m =>
                m.equipe_domicile === teamName || m.equipe_exterieur === teamName
            );

            // Par d√©faut, s√©lectionner tous les adversaires
            const opponents = new Set();
            teamMatches.forEach(m => {
                const opponent = m.equipe_domicile === teamName ? m.equipe_exterieur : m.equipe_domicile;
                opponents.add(opponent);
            });
            selectedOpponents = Array.from(opponents);

            // Charger les stats de l'√©quipe
            await loadTeamData();
            render();
        }

        // Charger les donn√©es d'une √©quipe
        async function loadTeamData() {
            if (!selectedTeam) return;

            const teamPlayers = {};

            // Filtrer les matchs selon les adversaires s√©lectionn√©s
            const filteredMatches = teamMatches.filter(m => {
                const opponent = m.equipe_domicile === selectedTeam ? m.equipe_exterieur : m.equipe_domicile;
                return selectedOpponents.includes(opponent);
            });

            for (const match of filteredMatches) {
                const response = await fetch(`${API_URL}/matches/${match.id}`);
                const result = await response.json();

                if (result.success) {
                    const matchData = result.data;
                    const players = matchData.stats_joueuses || [];

                    // Filtrer les joueuses de l'√©quipe s√©lectionn√©e
                    players.forEach(p => {
                        if (p.equipe.includes(selectedTeam.split(' ')[0])) {
                            const lastName = getLastName(p.nom);

                            if (!teamPlayers[lastName]) {
                                teamPlayers[lastName] = {
                                    nom: p.nom,
                                    matchs: 0,
                                    points: 0,
                                    rebonds: 0,
                                    passes: 0,
                                    tirs_reussis: 0,
                                    tirs_tentes: 0,
                                    tirs_2pts_reussis: 0,
                                    tirs_2pts_tentes: 0,
                                    tirs_3pts_reussis: 0,
                                    tirs_3pts_tentes: 0,
                                    lf_reussis: 0,
                                    lf_tentes: 0,
                                    balles_perdues: 0,
                                    interceptions: 0,
                                    contres: 0,
                                    fautes: 0,
                                    evaluation: 0
                                };
                            }

                            teamPlayers[lastName].matchs++;
                            teamPlayers[lastName].points += p.points || 0;
                            teamPlayers[lastName].rebonds += p.rebonds_total || 0;
                            teamPlayers[lastName].passes += p.passes_decisives || 0;
                            teamPlayers[lastName].tirs_reussis += p.tirs_reussis || 0;
                            teamPlayers[lastName].tirs_tentes += p.tirs_tentes || 0;
                            teamPlayers[lastName].tirs_2pts_reussis += p.tirs_2pts_reussis || 0;
                            teamPlayers[lastName].tirs_2pts_tentes += p.tirs_2pts_tentes || 0;
                            teamPlayers[lastName].tirs_3pts_reussis += p.tirs_3pts_reussis || 0;
                            teamPlayers[lastName].tirs_3pts_tentes += p.tirs_3pts_tentes || 0;
                            teamPlayers[lastName].lf_reussis += p.lf_reussis || 0;
                            teamPlayers[lastName].lf_tentes += p.lf_tentes || 0;
                            teamPlayers[lastName].balles_perdues += p.balles_perdues || 0;
                            teamPlayers[lastName].interceptions += p.interceptions || 0;
                            teamPlayers[lastName].contres += p.contres || 0;
                            teamPlayers[lastName].fautes += p.fautes || 0;
                            teamPlayers[lastName].evaluation += p.evaluation || 0;
                        }
                    });
                }
            }

            teamStatsCache = Object.values(teamPlayers);
        }

        // Helper pour extraire le nom de famille
        function getLastName(fullName) {
            if (!fullName) return '';
            const parts = fullName.trim().split(/\s+/);
            return parts[parts.length - 1];
        }

        // Toggle un adversaire
        async function toggleOpponent(opponent) {
            const index = selectedOpponents.indexOf(opponent);
            if (index > -1) {
                selectedOpponents.splice(index, 1);
            } else {
                selectedOpponents.push(opponent);
            }
            await loadTeamData();
            render();
        }

        // Toggle tous les adversaires
        async function toggleAllOpponents(checkbox) {
            if (checkbox.checked) {
                const opponents = new Set();
                teamMatches.forEach(m => {
                    const opponent = m.equipe_domicile === selectedTeam ? m.equipe_exterieur : m.equipe_domicile;
                    opponents.add(opponent);
                });
                selectedOpponents = Array.from(opponents);
            } else {
                selectedOpponents = [];
            }
            await loadTeamData();
            render();
        }

        // Vue principale Autres √âquipes
        function renderAutresView() {
            const teams = getUniqueTeams();

            return `
                <div class="card">
                    <h2>üîç Analyse des Autres √âquipes</h2>

                    <!-- Section d'upload -->
                    <div class="upload-section">
                        <h3>‚ûï Ajouter un match (sans CSMF)</h3>
                        <div class="file-input-wrapper">
                            <input type="file" id="pdfFileAutres" accept=".pdf" />
                            <button class="btn btn-primary" onclick="uploadNonCsmfMatch()">
                                üì§ Importer le PDF
                            </button>
                        </div>
                        <div id="uploadMessageAutres" class="message"></div>
                        <p style="color: #999; font-size: 13px; margin-top: 10px;">
                            ‚ö†Ô∏è Les matchs contenant le CSMF seront automatiquement rejet√©s
                        </p>
                    </div>

                    <!-- Liste des matchs non-CSMF -->
                    <h3 style="margin-top: 30px;">üìã Matchs disponibles (${allNonCsmfMatches.length})</h3>
                    ${allNonCsmfMatches.length > 0 ? `
                        <div class="match-selector">
                            ${allNonCsmfMatches.map(m => `
                                <div style="position: relative;">
                                    <button class="match-btn" style="width: 100%; text-align: left; cursor: default;">
                                        ${m.equipe_domicile} vs ${m.equipe_exterieur}
                                        <br><small>${m.date} ‚Ä¢ ${m.score_domicile}-${m.score_exterieur}</small>
                                    </button>
                                    <button class="btn btn-danger btn-small"
                                            onclick="deleteNonCsmfMatch(${m.id}, event)"
                                            style="position: absolute; top: 5px; right: 5px;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #999;">Aucun match import√©</p>'}

                    ${teams.length > 0 ? `
                        <!-- S√©lection d'√©quipe -->
                        <h3 style="margin-top: 30px;">üéØ S√©lectionner une √©quipe √† analyser</h3>
                        <select onchange="selectTeam(this.value)" style="width: 100%; padding: 10px; font-size: 16px;">
                            <option value="">-- Choisir une √©quipe --</option>
                            ${teams.map(t => `
                                <option value="${t}" ${selectedTeam === t ? 'selected' : ''}>${t}</option>
                            `).join('')}
                        </select>

                        ${selectedTeam ? renderTeamAnalysis() : ''}
                    ` : ''}
                </div>
            `;
        }

        // Analyse de l'√©quipe s√©lectionn√©e
        function renderTeamAnalysis() {
            // Liste des adversaires
            const opponents = new Set();
            teamMatches.forEach(m => {
                const opponent = m.equipe_domicile === selectedTeam ? m.equipe_exterieur : m.equipe_domicile;
                opponents.add(opponent);
            });
            const allOpponents = Array.from(opponents);

            return `
                <div style="margin-top: 30px; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                    <h3>üìä Analyse de ${selectedTeam}</h3>
                    <p style="color: #666;">${teamMatches.length} match(s) disponible(s)</p>

                    <!-- Filtrage par adversaire -->
                    <div style="margin: 20px 0;">
                        <h4>Filtrer par adversaire :</h4>
                        <div class="checkbox-group" style="margin-top: 10px;">
                            <label class="checkbox-label">
                                <input type="checkbox"
                                       ${selectedOpponents.length === allOpponents.length ? 'checked' : ''}
                                       onchange="toggleAllOpponents(this)">
                                Tous les adversaires
                            </label>
                            ${allOpponents.map(opp => `
                                <label class="checkbox-label">
                                    <input type="checkbox"
                                           ${selectedOpponents.includes(opp) ? 'checked' : ''}
                                           onchange="toggleOpponent('${opp}')">
                                    ${opp}
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    ${selectedOpponents.length > 0 && teamStatsCache ? renderTeamStats() : '<p style="color: #999;">S√©lectionnez au moins un adversaire</p>'}
                </div>
            `;
        }

        // Stats globales de l'√©quipe
        function renderTeamStats() {
            if (!teamStatsCache || teamStatsCache.length === 0) {
                return '<p style="color: #999;">Aucune statistique disponible</p>';
            }

            // Calculer les stats globales
            const totalPoints = teamStatsCache.reduce((sum, p) => sum + p.points, 0);
            const totalMatches = selectedOpponents.length;
            const avgPoints = (totalPoints / totalMatches).toFixed(1);

            return `
                <div style="margin-top: 20px;">
                    <div class="summary-stats">
                        <h3>R√©sum√©</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="label">Matchs analys√©s</div>
                                <div class="value">${totalMatches}</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">Points marqu√©s</div>
                                <div class="value">${totalPoints}</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">Moyenne / match</div>
                                <div class="value">${avgPoints}</div>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">üë• Statistiques des Joueuses</h3>
                    <div class="scroll-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueuse</th>
                                    <th>Matchs</th>
                                    <th>PTS</th>
                                    <th>Moy PTS</th>
                                    <th>REB</th>
                                    <th>PD</th>
                                    <th>Tirs %</th>
                                    <th>3pts %</th>
                                    <th>LF %</th>
                                    <th>BP</th>
                                    <th>INT</th>
                                    <th>CTR</th>
                                    <th>FT</th>
                                    <th>EVAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${teamStatsCache.sort((a, b) => b.points - a.points).map(p => {
                                    const tirsPerc = p.tirs_tentes > 0 ? ((p.tirs_reussis / p.tirs_tentes) * 100).toFixed(1) : 0;
                                    const tirs3Perc = p.tirs_3pts_tentes > 0 ? ((p.tirs_3pts_reussis / p.tirs_3pts_tentes) * 100).toFixed(1) : 0;
                                    const lfPerc = p.lf_tentes > 0 ? ((p.lf_reussis / p.lf_tentes) * 100).toFixed(1) : 0;

                                    return `
                                        <tr>
                                            <td style="font-weight: 600;">${p.nom}</td>
                                            <td>${p.matchs}</td>
                                            <td><span class="stat-badge">${p.points}</span></td>
                                            <td>${(p.points / p.matchs).toFixed(1)}</td>
                                            <td>${p.rebonds}</td>
                                            <td>${p.passes}</td>
                                            <td>${tirsPerc}%</td>
                                            <td>${tirs3Perc}%</td>
                                            <td>${lfPerc}%</td>
                                            <td>${p.balles_perdues}</td>
                                            <td>${p.interceptions}</td>
                                            <td>${p.contres}</td>
                                            <td>${p.fautes}</td>
                                            <td>${p.evaluation}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }


        // ========== COACHING IA OLLAMA ==========
        const OLLAMA_API_URL = 'http://92.170.164.144:5001';
        let coachingCache = {};

        async function checkOllamaStatus() {
            try {
                const r = await fetch(OLLAMA_API_URL + '/health');
                const d = await r.json();
                return d.ollama_connected;
            } catch { return false; }
        }

        async function analyzeMatchWithAI(matchId) {
            const k = 'match_' + matchId;
            if (coachingCache[k]) return coachingCache[k];
            try {
                const r = await fetch(OLLAMA_API_URL + '/api/coaching/match/' + matchId);
                const d = await r.json();
                if (d.success) { coachingCache[k] = d; return d; }
            } catch (e) { console.error('IA:', e); }
            return null;
        }

        async function analyzeGlobalWithAI(matchIds, playersStats) {
            const k = 'global_' + matchIds.sort().join('_');
            if (coachingCache[k]) return coachingCache[k];
            try {
                const r = await fetch(OLLAMA_API_URL + '/api/coaching/global', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_ids: matchIds, players_stats: playersStats })
                });
                const d = await r.json();
                if (d.success) { coachingCache[k] = d; return d; }
            } catch (e) { console.error('IA:', e); }
            return null;
        }

        async function renderCoachingForMatch(match) {
            const c = document.getElementById('coaching-section');
            if (!c) return;
            c.innerHTML = '<div class="coaching-card"><h2>ü§ñ Analyse IA</h2><div class="coaching-loader"><div class="spinner"></div><p>Analyse en cours... ‚è≥</p></div></div>';
            const ok = await checkOllamaStatus();
            if (!ok) {
                c.innerHTML = '<div class="coaching-card coaching-error"><h2>‚ö†Ô∏è IA Non Disponible</h2><p>Lancez: <code>python api_server_ollama.py</code></p></div>';
                return;
            }
            const a = await analyzeMatchWithAI(match.id);
            if (!a || !a.success) {
                c.innerHTML = '<div class="coaching-card coaching-error"><h2>‚ùå Erreur</h2></div>';
                return;
            }
            const f = a.analysis.forces || [];
            const w = a.analysis.faiblesses || [];
            const co = a.analysis.conseils || [];
            const s = a.match_summary;
            const vic = s.victoire ? '‚úÖ VICTOIRE' : '‚ùå D√âFAITE';
            c.innerHTML = '<div class="coaching-card"><h2>ü§ñ Analyse IA</h2><div class="coaching-summary"><strong>' + vic + '</strong> contre ' + s.adversaire + ' (' + s.score_csmf + '-' + s.score_adv + ')</div><div class="coaching-section"><h3>üí™ Points Forts</h3><ul class="coaching-list">' + f.map(function(x){ return '<li>' + x + '</li>'; }).join('') + '</ul></div><div class="coaching-section"><h3>üéØ √Ä Am√©liorer</h3><ul class="coaching-list coaching-warning">' + w.map(function(x){ return '<li>' + x + '</li>'; }).join('') + '</ul></div><div class="coaching-section"><h3>üìã Conseils</h3><ul class="coaching-list coaching-advice">' + co.map(function(x){ return '<li>' + x + '</li>'; }).join('') + '</ul></div><div class="coaching-footer"><small>üí° IA Llama 3.2</small><button onclick="refreshCoaching(' + match.id + ')" class="btn-refresh">üîÑ</button></div></div>';
        }

        async function renderGlobalCoaching(matchIds, playersStats) {
            const c = document.getElementById('global-coaching-section');
            if (!c) return;
            c.innerHTML = '<div class="coaching-card"><h2>ü§ñ Bilan</h2><div class="coaching-loader"><div class="spinner"></div><p>Analyse...</p></div></div>';
            const ok = await checkOllamaStatus();
            if (!ok) {
                c.innerHTML = '<div class="coaching-card coaching-error"><h2>‚ö†Ô∏è IA Indisponible</h2></div>';
                return;
            }
            const a = await analyzeGlobalWithAI(matchIds, playersStats);
            if (!a || !a.success) {
                c.innerHTML = '<div class="coaching-card coaching-error"><h2>‚ùå Erreur</h2></div>';
                return;
            }
            const t = a.analysis.tendances || [];
            const f = a.analysis.forces || [];
            const ax = a.analysis.axes_progression || [];
            const r = a.analysis.rotations || [];
            const s = a.summary;
            c.innerHTML = '<div class="coaching-card"><h2>ü§ñ Bilan CSMF</h2><div class="coaching-summary">üìä ' + s.nb_matchs + ' matchs ‚Ä¢ ' + s.victoires + 'V-' + s.defaites + 'D ‚Ä¢ ' + s.avg_points + 'pts/match</div><div class="coaching-section"><h3>üìä Tendances</h3><ul class="coaching-list">' + t.map(function(x){ return '<li>' + x + '</li>'; }).join('') + '</ul></div><div class="coaching-section"><h3>üí™ Forces</h3><ul class="coaching-list">' + f.map(function(x){ return '<li>' + x + '</li>'; }).join('') + '</ul></div><div class="coaching-section"><h3>üéØ Progression</h3><ul class="coaching-list coaching-warning">' + ax.map(function(x){ return '<li>' + x + '</li>'; }).join('') + '</ul></div><div class="coaching-section"><h3>üîÑ Strat√©gie</h3><ul class="coaching-list coaching-advice">' + r.map(function(x){ return '<li>' + x + '</li>'; }).join('') + '</ul></div><div class="coaching-footer"><small>üí° IA Llama 3.2</small></div></div>';
        }

        function refreshCoaching(matchId) {
            delete coachingCache['match_' + matchId];
            renderCoachingForMatch(currentMatch);
        }

        // Auto-render coaching
        const origRender = render;
        render = function() {
            origRender();
            setTimeout(function() {
                if (currentView === 'matches' && currentMatch) {
                    let d = document.getElementById('coaching-section');
                    if (!d) {
                        const t = document.querySelector('.tab-content.active');
                        if (t) { d = document.createElement('div'); d.id = 'coaching-section'; t.appendChild(d); }
                    }
                    if (d) renderCoachingForMatch(currentMatch);
                }
                if (currentView === 'csmf' && selectedMatchesForCsmf.length > 0 && csmfDataCache) {
                    let d = document.getElementById('global-coaching-section');
                    if (!d) {
                        const c = document.querySelector('.container');
                        if (c) { d = document.createElement('div'); d.id = 'global-coaching-section'; c.appendChild(d); }
                    }
                    if (d) renderGlobalCoaching(selectedMatchesForCsmf, csmfDataCache.players);
                }
            }, 300);
        };


        // ========================================
        // PAGE D√âDI√âE JOUEUSE (Style NBA)
        // ========================================

        async function showPlayerDetails(playerName) {
            console.log(`Affichage des d√©tails pour: ${playerName}`);

            // Charger toutes les stats de la joueuse
            const playerDataResult = await loadPlayerData(playerName);
            const playerData = playerDataResult.matches;
            const playerLineups = playerDataResult.lineups;

            if (!playerData || playerData.length === 0) {
                alert(`Aucune donn√©e trouv√©e pour ${playerName}`);
                return;
            }

            // Cr√©er et afficher la modal
            const modal = createPlayerModal(playerName, playerData, playerLineups);
            document.body.appendChild(modal);

            // Dessiner les graphiques
            setTimeout(() => {
                drawPlayerCharts(playerName, playerData);
            }, 100);
        }

        async function loadPlayerData(playerName) {
            const matchesData = [];
            const allLineups = [];

            // Extraire le nom de famille pour la recherche
            const lastName = playerName.split(' ').pop().toUpperCase();

            for (const matchId of selectedMatchesForCsmf) {
                const response = await fetch(`${API_URL}/matches/${matchId}`);
                const result = await response.json();

                if (result.success) {
                    const match = result.data;
                    const player = match.stats_joueuses.find(p =>
                        p.equipe && p.equipe.includes('CSMF') &&
                        p.nom && p.nom.includes(playerName.split(' ').pop())
                    );

                    if (player) {
                        matchesData.push({
                            ...player,
                            matchId: matchId,
                            date: match.date,
                            adversaire: match.equipe_domicile.includes('CSMF') ?
                                match.equipe_exterieur : match.equipe_domicile,
                            score_csmf: match.equipe_domicile.includes('CSMF') ?
                                match.score_domicile : match.score_exterieur,
                            score_adv: match.equipe_domicile.includes('CSMF') ?
                                match.score_exterieur : match.score_domicile,
                            victoire: (match.equipe_domicile.includes('CSMF') && match.score_domicile > match.score_exterieur) ||
                                     (match.equipe_exterieur.includes('CSMF') && match.score_exterieur > match.score_domicile)
                        });
                    }

                    // Charger les combinaisons de 5 pour ce match
                    try {
                        const lineupsResponse = await fetch(`${API_URL}/matches/${matchId}/lineups`);
                        const lineupsResult = await lineupsResponse.json();
                        if (lineupsResult.success && lineupsResult.data) {
                            // Filtrer les combinaisons CSMF o√π la joueuse appara√Æt
                            const playerLineups = lineupsResult.data.filter(l => {
                                if (!l.equipe || !l.equipe.includes('CSMF')) return false;
                                // Chercher le nom de famille dans la liste des joueurs
                                return l.joueurs && l.joueurs.toUpperCase().includes(lastName);
                            });

                            playerLineups.forEach(l => {
                                allLineups.push({
                                    ...l,
                                    matchId: matchId,
                                    date: match.date,
                                    adversaire: match.equipe_domicile.includes('CSMF') ?
                                        match.equipe_exterieur : match.equipe_domicile
                                });
                            });
                        }
                    } catch (e) {
                        // Pas de combinaisons pour ce match
                    }
                }
            }

            return {
                matches: matchesData.sort((a, b) => new Date(a.date) - new Date(b.date)),
                lineups: allLineups
            };
        }

        function createPlayerModal(playerName, playerData, playerLineups = []) {
            const modal = document.createElement('div');
            modal.id = 'player-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                overflow-y: auto;
                padding: 20px;
            `;

            // Calculer les stats globales
            const totalMatchs = playerData.length;
            const avgPts = (playerData.reduce((s, p) => s + (p.points || 0), 0) / totalMatchs).toFixed(1);
            const avgEval = (playerData.reduce((s, p) => s + (p.evaluation || 0), 0) / totalMatchs).toFixed(1);
            const avgReb = (playerData.reduce((s, p) => s + (p.rebonds_total || 0), 0) / totalMatchs).toFixed(1);
            const avgRO = (playerData.reduce((s, p) => s + (p.rebonds_offensifs || 0), 0) / totalMatchs).toFixed(1);
            const avgRD = (playerData.reduce((s, p) => s + (p.rebonds_defensifs || 0), 0) / totalMatchs).toFixed(1);
            const avgPD = (playerData.reduce((s, p) => s + (p.passes_decisives || 0), 0) / totalMatchs).toFixed(1);
            const avgBP = (playerData.reduce((s, p) => s + (p.balles_perdues || 0), 0) / totalMatchs).toFixed(1);
            const avgINT = (playerData.reduce((s, p) => s + (p.interceptions || 0), 0) / totalMatchs).toFixed(1);
            const victoires = playerData.filter(p => p.victoire).length;
            const defaites = totalMatchs - victoires;

            const totalTirsR = playerData.reduce((s, p) => s + (p.tirs_reussis || 0), 0);
            const totalTirsT = playerData.reduce((s, p) => s + (p.tirs_tentes || 0), 0);
            const pctTirs = totalTirsT > 0 ? ((totalTirsR / totalTirsT) * 100).toFixed(1) : 0;

            const total2ptsR = playerData.reduce((s, p) => s + (p.tirs_2pts_reussis || 0), 0);
            const total2ptsT = playerData.reduce((s, p) => s + (p.tirs_2pts_tentes || 0), 0);
            const pct2pts = total2ptsT > 0 ? ((total2ptsR / total2ptsT) * 100).toFixed(1) : 0;

            const total3ptsR = playerData.reduce((s, p) => s + (p.tirs_3pts_reussis || 0), 0);
            const total3ptsT = playerData.reduce((s, p) => s + (p.tirs_3pts_tentes || 0), 0);
            const pct3pts = total3ptsT > 0 ? ((total3ptsR / total3ptsT) * 100).toFixed(1) : 0;

            const totalLFR = playerData.reduce((s, p) => s + (p.lf_reussis || 0), 0);
            const totalLFT = playerData.reduce((s, p) => s + (p.lf_tentes || 0), 0);
            const pctLF = totalLFT > 0 ? ((totalLFR / totalLFT) * 100).toFixed(1) : 0;

            // Analyser les combinaisons de 5
            const lineupsSection = renderPlayerLineupsSection(playerName, playerLineups);

            modal.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 40px; position: relative;">
                    <button onclick="closePlayerModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 30px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.3s;">&times;</button>

                    <!-- Header NBA Style -->
                    <div style="text-align: center; margin-bottom: 40px;">
                        <div style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; font-weight: bold;">
                            ${playerName.split(' ')[0][0]}${playerName.split(' ').pop()[0]}
                        </div>
                        <h1 style="color: white; font-size: 42px; margin: 10px 0;">${playerName}</h1>
                        <p style="color: #aaa; font-size: 20px;">CSMF PARIS ‚Ä¢ #${playerData[0].numero || '?'}</p>
                        <div style="display: inline-block; background: ${victoires > defaites ? '#28a745' : '#dc3545'}; color: white; padding: 10px 30px; border-radius: 30px; font-size: 18px; margin-top: 10px;">
                            ${victoires}V - ${defaites}D
                        </div>
                    </div>

                    <!-- Stats Principales (grandes cartes) -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 40px;">
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center; border: 2px solid rgba(255,215,0,0.3);">
                            <div style="font-size: 36px; font-weight: bold; color: #ffd700;">${avgEval}</div>
                            <div style="color: #aaa; font-size: 14px; margin-top: 8px;">EVAL</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: white;">${avgPts}</div>
                            <div style="color: #aaa; font-size: 14px; margin-top: 8px;">PTS</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: white;">${avgReb}</div>
                            <div style="color: #aaa; font-size: 14px; margin-top: 8px;">REB</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: white;">${avgPD}</div>
                            <div style="color: #aaa; font-size: 14px; margin-top: 8px;">PD</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: white;">${pctTirs}%</div>
                            <div style="color: #aaa; font-size: 14px; margin-top: 8px;">FG%</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #10b981;">${avgINT}</div>
                            <div style="color: #aaa; font-size: 14px; margin-top: 8px;">INT</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #f59e0b;">${avgBP}</div>
                            <div style="color: #aaa; font-size: 14px; margin-top: 8px;">BP</div>
                        </div>
                    </div>

                    <!-- Stats Tirs D√©taill√©es -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 40px;">
                        <div style="background: rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(102, 126, 234, 0.5);">
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;">${pct2pts}%</div>
                            <div style="color: #aaa; font-size: 12px; margin-top: 5px;">2PTS (${total2ptsR}/${total2ptsT})</div>
                        </div>
                        <div style="background: rgba(118, 75, 162, 0.2); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(118, 75, 162, 0.5);">
                            <div style="font-size: 28px; font-weight: bold; color: #764ba2;">${pct3pts}%</div>
                            <div style="color: #aaa; font-size: 12px; margin-top: 5px;">3PTS (${total3ptsR}/${total3ptsT})</div>
                        </div>
                        <div style="background: rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(255, 215, 0, 0.5);">
                            <div style="font-size: 28px; font-weight: bold; color: #ffd700;">${pctLF}%</div>
                            <div style="color: #aaa; font-size: 12px; margin-top: 5px;">LF (${totalLFR}/${totalLFT})</div>
                        </div>
                        <div style="background: rgba(40, 167, 69, 0.2); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(40, 167, 69, 0.5);">
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;">${avgRO}</div>
                            <div style="color: #aaa; font-size: 12px; margin-top: 5px;">REB OFF</div>
                        </div>
                        <div style="background: rgba(23, 162, 184, 0.2); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(23, 162, 184, 0.5);">
                            <div style="font-size: 28px; font-weight: bold; color: #17a2b8;">${avgRD}</div>
                            <div style="color: #aaa; font-size: 12px; margin-top: 5px;">REB DEF</div>
                        </div>
                    </div>

                    <!-- Section Combinaisons de 5 -->
                    ${lineupsSection}

                    <!-- Graphiques -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px;">
                            <h3 style="color: white; margin-bottom: 20px;">üìà √âvolution Points</h3>
                            <canvas id="chart-points" style="max-height: 250px;"></canvas>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px;">
                            <h3 style="color: white; margin-bottom: 20px;">üìä √âvolution EVAL</h3>
                            <canvas id="chart-eval" style="max-height: 250px;"></canvas>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px;">
                            <h3 style="color: white; margin-bottom: 20px;">üéØ R√©partition Paniers</h3>
                            <canvas id="chart-scoring" style="max-height: 250px;"></canvas>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px;">
                            <h3 style="color: white; margin-bottom: 20px;">‚≠ê Profil Joueur</h3>
                            <canvas id="chart-radar" style="max-height: 250px;"></canvas>
                        </div>
                    </div>

                    <!-- Stats par match -->
                    <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px;">
                        <h3 style="color: white; margin-bottom: 20px;">üìã D√©tails par Match</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; color: white; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.1); border-bottom: 2px solid rgba(255,255,255,0.2);">
                                        <th style="padding: 12px; text-align: left;">Date</th>
                                        <th style="padding: 12px; text-align: left;">Adversaire</th>
                                        <th style="padding: 12px; text-align: center;">Score</th>
                                        <th style="padding: 12px; text-align: center;">MIN</th>
                                        <th style="padding: 12px; text-align: center;">PTS</th>
                                        <th style="padding: 12px; text-align: center;">REB</th>
                                        <th style="padding: 12px; text-align: center;">PD</th>
                                        <th style="padding: 12px; text-align: center;">FG%</th>
                                        <th style="padding: 12px; text-align: center;">+/-</th>
                                        <th style="padding: 12px; text-align: center;">EVAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${playerData.map(m => {
                                        const fgPct = m.tirs_tentes > 0 ? ((m.tirs_reussis / m.tirs_tentes) * 100).toFixed(1) : 0;
                                        return `
                                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                                <td style="padding: 12px;">${m.date}</td>
                                                <td style="padding: 12px;">${m.adversaire}</td>
                                                <td style="padding: 12px; text-align: center;">
                                                    <span style="color: ${m.victoire ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                                        ${m.victoire ? 'V' : 'D'} ${m.score_csmf}-${m.score_adv}
                                                    </span>
                                                </td>
                                                <td style="padding: 12px; text-align: center;">${m.minutes || '-'}</td>
                                                <td style="padding: 12px; text-align: center; font-weight: bold;">${m.points || 0}</td>
                                                <td style="padding: 12px; text-align: center;">${m.rebonds_total || 0}</td>
                                                <td style="padding: 12px; text-align: center;">${m.passes_decisives || 0}</td>
                                                <td style="padding: 12px; text-align: center;">${fgPct}%</td>
                                                <td style="padding: 12px; text-align: center; color: ${(m.plus_moins || 0) >= 0 ? '#28a745' : '#dc3545'};">${m.plus_moins >= 0 ? '+' : ''}${m.plus_moins || 0}</td>
                                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #ffd700;">${m.evaluation || 0}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            return modal;
        }

        // Fonction pour afficher les combinaisons de 5 dans la fiche joueuse
        function renderPlayerLineupsSection(playerName, lineups) {
            if (!lineups || lineups.length === 0) {
                return `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px; margin-bottom: 40px;">
                        <h3 style="color: white; margin-bottom: 15px;">üèÄ Combinaisons de 5</h3>
                        <p style="color: #aaa; text-align: center;">Aucune donn√©e de combinaisons disponible</p>
                    </div>
                `;
            }

            const lastName = playerName.split(' ').pop().toUpperCase();

            // Fonction pour normaliser les joueurs d'une combinaison (ordre alphab√©tique)
            function normalizeLineupKey(joueurs) {
                return joueurs.split('/').map(p => p.trim()).filter(p => p).sort().join('/');
            }

            // Agr√©ger les combinaisons identiques sur tous les matchs
            const lineupAggregates = {};
            lineups.forEach(l => {
                const key = normalizeLineupKey(l.joueurs);
                if (!lineupAggregates[key]) {
                    lineupAggregates[key] = {
                        joueurs: l.joueurs,
                        total_temps_secondes: 0,
                        total_ecart: 0,
                        total_score_pour: 0,
                        matchs: [],
                        count: 0
                    };
                }
                // Compatibilit√© avec les deux formats de noms de champs
                lineupAggregates[key].total_temps_secondes += l.duree_secondes ?? l.temps_secondes ?? 0;
                lineupAggregates[key].total_ecart += l.plus_minus ?? l.ecart ?? 0;
                lineupAggregates[key].total_score_pour += l.points_marques ?? l.score_pour ?? 0;
                lineupAggregates[key].matchs.push(l.adversaire || 'Match');
                lineupAggregates[key].count++;
            });

            // Calculer les moyennes
            const aggregatedLineups = Object.values(lineupAggregates).map(agg => {
                const minutes = agg.total_temps_secondes / 60;
                return {
                    joueurs: agg.joueurs,
                    temps_total: agg.total_temps_secondes,
                    temps_display: `${Math.floor(minutes)}:${String(Math.round((minutes % 1) * 60)).padStart(2, '0')}`,
                    ecart_total: agg.total_ecart,
                    ecart_moyen: agg.count > 0 ? (agg.total_ecart / agg.count).toFixed(1) : 0,
                    pts_par_min: minutes > 0 ? (agg.total_score_pour / minutes).toFixed(2) : 0,
                    nb_matchs: agg.count
                };
            }).filter(l => l.temps_total >= 60); // Minimum 1 minute

            // Trier par √©cart moyen
            const sortedLineups = [...aggregatedLineups].sort((a, b) => parseFloat(b.ecart_moyen) - parseFloat(a.ecart_moyen));
            const bestLineups = sortedLineups.filter(l => parseFloat(l.ecart_moyen) > 0).slice(0, 3);
            const worstLineups = sortedLineups.filter(l => parseFloat(l.ecart_moyen) < 0).slice(-3).reverse();

            // Calculer les stats globales sur les donn√©es agr√©g√©es
            const totalLineups = aggregatedLineups.length;
            const positiveLineups = aggregatedLineups.filter(l => parseFloat(l.ecart_moyen) > 0).length;
            const negativeLineups = aggregatedLineups.filter(l => parseFloat(l.ecart_moyen) < 0).length;
            const avgEcart = aggregatedLineups.length > 0
                ? (aggregatedLineups.reduce((sum, l) => sum + parseFloat(l.ecart_moyen), 0) / aggregatedLineups.length).toFixed(1)
                : 0;
            const totalTime = aggregatedLineups.reduce((sum, l) => sum + (l.temps_total || 0), 0);
            const totalMinutes = Math.floor(totalTime / 60);

            // Fonction pour formater les co√©quipi√®res (sans la joueuse elle-m√™me)
            function formatTeammates(joueurs) {
                const players = joueurs.split('/').filter(p => p.trim());
                const teammates = players.filter(p => !p.toUpperCase().includes(lastName));
                return teammates.map(p => {
                    const match = p.trim().match(/(\d+)-\s*([A-Z]+)/i);
                    return match ? match[2] : p.trim();
                }).join(', ');
            }

            return `
                <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px; margin-bottom: 40px;">
                    <h3 style="color: white; margin-bottom: 20px;">ü¶Ü Combinaisons de 5 avec ${playerName.split(' ').pop()}</h3>

                    <!-- Stats r√©sum√©es -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: white;">${totalLineups}</div>
                            <div style="color: #aaa; font-size: 12px;">Combinaisons</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #4ade80;">${positiveLineups}</div>
                            <div style="color: #aaa; font-size: 12px;">Positives</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #f87171;">${negativeLineups}</div>
                            <div style="color: #aaa; font-size: 12px;">N√©gatives</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: ${parseFloat(avgEcart) >= 0 ? '#4ade80' : '#f87171'};">${avgEcart >= 0 ? '+' : ''}${avgEcart}</div>
                            <div style="color: #aaa; font-size: 12px;">√âcart moyen</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: white;">${totalMinutes}'</div>
                            <div style="color: #aaa; font-size: 12px;">Temps total</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Meilleures combinaisons -->
                        <div>
                            <h4 style="color: #4ade80; margin-bottom: 15px;">‚úÖ Meilleures associations (moyenne)</h4>
                            ${bestLineups.length > 0 ? bestLineups.map(l => `
                                <div style="background: rgba(74, 222, 128, 0.1); border-left: 4px solid #4ade80; padding: 12px; margin-bottom: 10px; border-radius: 0 8px 8px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #4ade80; font-weight: bold; font-size: 20px;">+${l.ecart_moyen}<span style="font-size: 11px; color: #888; font-weight: normal;"> moy</span></span>
                                        <span style="color: #aaa; font-size: 12px;">${l.nb_matchs} match${l.nb_matchs > 1 ? 's' : ''} ‚Ä¢ ${l.temps_display}</span>
                                    </div>
                                    <div style="color: white; margin-top: 8px; font-size: 14px;">
                                        avec ${formatTeammates(l.joueurs)}
                                    </div>
                                    <div style="color: #666; font-size: 11px; margin-top: 4px;">
                                        √âcart total: +${l.ecart_total} ‚Ä¢ ${l.pts_par_min} pts/min
                                    </div>
                                </div>
                            `).join('') : '<p style="color: #aaa;">Aucune combinaison positive</p>'}
                        </div>

                        <!-- Pires combinaisons -->
                        <div>
                            <h4 style="color: #f87171; margin-bottom: 15px;">‚ö†Ô∏è Associations difficiles (moyenne)</h4>
                            ${worstLineups.length > 0 ? worstLineups.map(l => `
                                <div style="background: rgba(248, 113, 113, 0.1); border-left: 4px solid #f87171; padding: 12px; margin-bottom: 10px; border-radius: 0 8px 8px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #f87171; font-weight: bold; font-size: 20px;">${l.ecart_moyen}<span style="font-size: 11px; color: #888; font-weight: normal;"> moy</span></span>
                                        <span style="color: #aaa; font-size: 12px;">${l.nb_matchs} match${l.nb_matchs > 1 ? 's' : ''} ‚Ä¢ ${l.temps_display}</span>
                                    </div>
                                    <div style="color: white; margin-top: 8px; font-size: 14px;">
                                        avec ${formatTeammates(l.joueurs)}
                                    </div>
                                    <div style="color: #666; font-size: 11px; margin-top: 4px;">
                                        √âcart total: ${l.ecart_total} ‚Ä¢ ${l.pts_par_min} pts/min
                                    </div>
                                </div>
                            `).join('') : '<p style="color: #aaa;">Aucune combinaison n√©gative</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function closePlayerModal() {
            const modal = document.getElementById('player-modal');
            if (modal) {
                modal.remove();
            }
        }

        function drawPlayerCharts(playerName, playerData) {
            // V√©rifier que Chart.js est charg√©
            if (typeof Chart === 'undefined') {
                console.error('Chart.js n\'est pas charg√© !');
                return;
            }

            console.log('Cr√©ation des graphiques pour:', playerName);
            console.log('Donn√©es:', playerData);

            // 1. Graphique √âvolution Points
            const ctxPoints = document.getElementById('chart-points');
            if (ctxPoints) {
                console.log('Canvas points trouv√©, cr√©ation du graphique...');
                new Chart(ctxPoints, {
                    type: 'line',
                    data: {
                        labels: playerData.map((m, i) => `J${i+1}`),
                        datasets: [{
                            label: 'Points',
                            data: playerData.map(m => m.points || 0),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            } else {
                console.error('Canvas chart-points non trouv√© !');
            }

            // 2. Graphique √âvolution EVAL
            const ctxEval = document.getElementById('chart-eval');
            if (ctxEval) {
                new Chart(ctxEval, {
                    type: 'line',
                    data: {
                        labels: playerData.map((m, i) => `J${i+1}`),
                        datasets: [{
                            label: 'EVAL',
                            data: playerData.map(m => m.evaluation || 0),
                            borderColor: '#ffd700',
                            backgroundColor: 'rgba(255, 215, 0, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }

            // 3. Graphique R√©partition Paniers (Doughnut) - Nombre de paniers r√©ussis
            const ctxScoring = document.getElementById('chart-scoring');
            if (ctxScoring) {
                const total2pts = playerData.reduce((s, p) => s + (p.tirs_2pts_reussis || 0), 0);
                const total3pts = playerData.reduce((s, p) => s + (p.tirs_3pts_reussis || 0), 0);
                const totalLF = playerData.reduce((s, p) => s + (p.lf_reussis || 0), 0);

                new Chart(ctxScoring, {
                    type: 'doughnut',
                    data: {
                        labels: ['2pts r√©ussis', '3pts r√©ussis', 'LF r√©ussis'],
                        datasets: [{
                            data: [total2pts, total3pts, totalLF],
                            backgroundColor: ['#667eea', '#764ba2', '#ffd700'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: 'white', font: { size: 14 } }
                            }
                        }
                    }
                });
            }

            // 4. Radar Chart (Profil Joueur)
            const ctxRadar = document.getElementById('chart-radar');
            if (ctxRadar) {
                const avgPts = playerData.reduce((s, p) => s + (p.points || 0), 0) / playerData.length;
                const avgReb = playerData.reduce((s, p) => s + (p.rebonds_total || 0), 0) / playerData.length;
                const avgPD = playerData.reduce((s, p) => s + (p.passes_decisives || 0), 0) / playerData.length;
                const avgINT = playerData.reduce((s, p) => s + (p.interceptions || 0), 0) / playerData.length;
                const avgBP = playerData.reduce((s, p) => s + (p.balles_perdues || 0), 0) / playerData.length;

                new Chart(ctxRadar, {
                    type: 'radar',
                    data: {
                        labels: ['Points', 'Rebonds', 'Passes', 'Interceptions', 'Balles Perdues'],
                        datasets: [{
                            label: playerName,
                            data: [avgPts, avgReb, avgPD, avgINT, avgBP],
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                ticks: { color: 'white', backdropColor: 'transparent' },
                                grid: { color: 'rgba(255,255,255,0.2)' },
                                pointLabels: { color: 'white', font: { size: 12 } }
                            }
                        }
                    }
                });
            }
        }

        // D√©marrer l'application
        init();
    </script>
</body>
</html>
